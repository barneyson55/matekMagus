<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matek Mester</title>
    <link rel="stylesheet" href="style.css">
    <style>
        details details { margin-left: 15px; }
        details details ul { margin-left: 15px; }
        .sidebar-tooltip { position: absolute; background-color: #18191c; color: white; padding: 8px 12px; border-radius: 6px; font-size: 14px; z-index: 1000; display: none; white-space: nowrap; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .results-btn { background-color: var(--brand-secondary); color: white !important; font-weight: 600 !important; margin-bottom: 20px !important; justify-content: center !important; }
        .results-btn:hover { background-color: var(--brand-primary) !important; }
        .results-btn.active { background-color: var(--brand-primary) !important; }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div class="header-hamburger">
                <button class="icon-button" id="quest-toggle" type="button" aria-label="Küldetésnapló" aria-expanded="true">
                    <svg class="burger-icon" viewBox="0 0 64 64" aria-hidden="true" focusable="false">
                        <path class="burger-frame" d="M32 4 L54 16 V48 L32 60 L10 48 V16 Z"></path>
                        <path class="burger-bar" d="M20 24 H44"></path>
                        <path class="burger-bar" d="M20 32 H44"></path>
                        <path class="burger-bar" d="M20 40 H44"></path>
                    </svg>
                </button>
            </div>
            <div class="header-main">
                <div class="header-top">
                    <div class="buffs" aria-label="Aktív buffok">
                        <span class="buff-icon" title="Fókusz" aria-hidden="true"></span>
                        <span class="buff-icon" title="Kitartás" aria-hidden="true"></span>
                    </div>
                    <div class="app-title">MatekMester</div>
                    <div class="player-panel">
                        <button id="xp-level-label" class="player-level" type="button" aria-label="Karakterlap">Lv. 1</button>
                        <span id="xp-level-name" class="level-name" aria-hidden="true"></span>
                        <button class="avatar-button" id="player-avatar" type="button" aria-label="Karakterlap">
                            <span class="avatar" aria-hidden="true"></span>
                        </button>
                        <span id="xp-total-label" class="sr-only">0 XP</span>
                    </div>
                </div>
                <div class="header-bottom">
                    <div class="xp-bar" id="xp-bar" tabindex="0" aria-label="XP sáv">
                        <div class="xp-bar-fill" id="xp-bar-fill"></div>
                        <div class="xp-tooltip" id="xp-progress-text">0 / 50 XP a kovetkezo szintig</div>
                    </div>
                </div>
            </div>
        </header>
        <div class="app-container">
        <div class="quest-drawer-backdrop" id="quest-drawer-backdrop" aria-hidden="true"></div>
        <nav class="sidebar">
            <div>
                <a href="#" class="module-link results-btn" id="results-btn">Eredm&#233;nyeim</a>
            </div>
            <div class="module-list">
                <!-- Navigation source-of-truth: keep this manual list in index.html (no temakorok generation in this phase). -->

                <details>
                    <summary>
                        <a href="#" class="module-link main-topic" data-src="modules/alapozo_modulzaro.html"
                            data-topic-id="alapozo_modulzaro">&#173;&#269;&#244;&#220; Alapoz&#9500;&#9474; Modulok</a>
                        <span class="status grade-0" data-grade-for="alapozo_modulzaro"></span>
                    </summary>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/gondolkodas_temazaro.html"
                                data-topic-id="gondolkodas_temazaro">Gondolkod&#225;si m&#243;dszerek, Halmazok</a>
                            <span class="status grade-0" data-grade-for="gondolkodas_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/halmazmuveletek.html"
                                    data-topic-id="halmazmuveletek">Halmazm&#9532;&#9618;veletek<span class="status grade-0"
                                        data-grade-for="halmazmuveletek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/logikai_szita.html"
                                    data-topic-id="logikai_szita">Logikai szita formula<span class="status grade-0"
                                        data-grade-for="logikai_szita"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/skatulya_elv.html"
                                    data-topic-id="skatulya_elv">Skatulya-elv, p&#9500;&#237;ros&#9500;&#351;t&#9500;&#237;sok<span class="status grade-0"
                                        data-grade-for="skatulya_elv"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/szamelmelet_temazaro.html"
                                data-topic-id="szamelmelet_temazaro">Sz&#9500;&#237;melm&#9500;&#281;let &#9500;&#281;s Sz&#9500;&#237;mrendszerek</a>
                            <span class="status grade-0" data-grade-for="szamelmelet_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/oszthatosag.html"
                                    data-topic-id="oszthatosag">Oszthat&#243;s&#225;gi szab&#225;lyok<span class="status grade-0"
                                        data-grade-for="oszthatosag"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/lnko_lkkt.html"
                                    data-topic-id="lnko_lkkt">LNKO, LKKT<span class="status grade-0"
                                        data-grade-for="lnko_lkkt"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/primtenyezok.html"
                                    data-topic-id="primtenyezok">Pr&#9500;&#351;mt&#9500;&#281;nyez&#9532;&#313;s felbont&#9500;&#237;s<span class="status grade-0"
                                        data-grade-for="primtenyezok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/szamrendszerek.html"
                                    data-topic-id="szamrendszerek">Sz&#225;mrendszerek<span class="status grade-0"
                                        data-grade-for="szamrendszerek"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic"
                                data-src="modules/racionalis_szamok_temazaro.html"
                                data-topic-id="racionalis_szamok_temazaro">Racion&#225;lis sz&#225;mok</a>
                            <span class="status grade-0" data-grade-for="racionalis_szamok_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/tortek.html"
                                    data-topic-id="tortek">T&#9500;&#194;rtek &#9500;&#281;s m&#9532;&#9618;veletek<span class="status grade-0"
                                        data-grade-for="tortek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/tizedes_tortek.html"
                                    data-topic-id="tizedes_tortek">Tizedes t&#9500;&#194;rtek, &#9500;&#237;tv&#9500;&#237;lt&#9500;&#237;sok<span
                                        class="status grade-0" data-grade-for="tizedes_tortek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/szazalekszamitas.html"
                                    data-topic-id="szazalekszamitas">Sz&#9500;&#237;zal&#9500;&#281;ksz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s<span class="status grade-0"
                                        data-grade-for="szazalekszamitas"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/hatvany_temazaro.html"
                                data-topic-id="hatvany_temazaro">Hatv&#9500;&#237;ny, Gy&#9500;&#194;k, Logaritmus</a>
                            <span class="status grade-0" data-grade-for="hatvany_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/hatvanyozas.html"
                                    data-topic-id="hatvanyozas">Hatv&#225;nyoz&#225;s azonoss&#225;gai<span class="status grade-0"
                                        data-grade-for="hatvanyozas"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/gyokvonas.html"
                                    data-topic-id="gyokvonas">N&#9500;&#281;gyzetgy&#9500;&#194;k, n-edik gy&#9500;&#194;k<span class="status grade-0"
                                        data-grade-for="gyokvonas"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/logaritmus.html"
                                    data-topic-id="logaritmus">A logaritmus fogalma<span class="status grade-0"
                                        data-grade-for="logaritmus"></span></a></li>
                        </ul>
                    </details>
                </details>

                <details>
                    <summary>
                        <a href="#" class="module-link main-topic" data-src="modules/algebra_modulzaro.html"
                            data-topic-id="algebra_modulzaro">&#173;&#269;&#244;&#201; Algebra &#9500;&#281;s F&#9500;&#9565;ggv&#9500;&#281;nyek</a>
                        <span class="status grade-0" data-grade-for="algebra_modulzaro"></span>
                    </summary>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/algebrai_kif_temazaro.html"
                                data-topic-id="algebrai_kif_temazaro">Algebrai kifejez&#9500;&#281;sek</a>
                            <span class="status grade-0" data-grade-for="algebrai_kif_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/polinomok.html"
                                    data-topic-id="polinomok">M&#9532;&#9618;veletek polinomokkal<span class="status grade-0"
                                        data-grade-for="polinomok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/nevezetes_azonossagok.html"
                                    data-topic-id="nevezetes_azonossagok">Nevezetes azonoss&#225;gok<span
                                        class="status grade-0" data-grade-for="nevezetes_azonossagok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/algebrai_tortek.html"
                                    data-topic-id="algebrai_tortek">Algebrai t&#9500;&#194;rtek<span class="status grade-0"
                                        data-grade-for="algebrai_tortek"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/egyenletek_temazaro.html"
                                data-topic-id="egyenletek_temazaro">Egyenletek, Egyenl&#9532;&#313;tlens&#9500;&#281;gek</a>
                            <span class="status grade-0" data-grade-for="egyenletek_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/linearis_egyenletek.html"
                                    data-topic-id="linearis_egyenletek">Line&#225;ris egyenletek<span class="status grade-0"
                                        data-grade-for="linearis_egyenletek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/masodfoku_egyenlet.html"
                                    data-topic-id="masodfoku_egyenlet">M&#225;sodfok&#250; egyenlet<span class="status grade-0"
                                        data-grade-for="masodfoku_egyenlet"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/viete_formulak.html"
                                    data-topic-id="viete_formulak">Vi&#9500;&#280;te-formul&#9500;&#237;k<span class="status grade-0"
                                        data-grade-for="viete_formulak"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/parameteres_masodfoku.html"
                                    data-topic-id="parameteres_masodfoku">Param&#9500;&#281;teres m&#9500;&#237;sodfok&#9500;&#9553; egyenletek<span
                                        class="status grade-0" data-grade-for="parameteres_masodfoku"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/specialis_egyenletek.html"
                                    data-topic-id="specialis_egyenletek">Abszol&#9500;&#9553;t&#9500;&#281;rt&#9500;&#281;kes, gy&#9500;&#194;k&#9500;&#194;s stb.<span
                                        class="status grade-0" data-grade-for="specialis_egyenletek"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/fuggvenyek_alt_temazaro.html"
                                data-topic-id="fuggvenyek_alt_temazaro">F&#9500;&#9565;ggv&#9500;&#281;nyek &#9500;&#252;ltal&#9500;&#237;nos Tulajdons&#9500;&#237;gai</a>
                            <span class="status grade-0" data-grade-for="fuggvenyek_alt_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/fuggveny_alapok.html"
                                    data-topic-id="fuggveny_alapok">&#9500;&#235;rtelmez&#9500;&#281;si tartom&#9500;&#237;ny, &#9500;&#281;rt&#9500;&#281;kk&#9500;&#281;szlet<span
                                        class="status grade-0" data-grade-for="fuggveny_alapok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/fuggveny_jellemzes.html"
                                    data-topic-id="fuggveny_jellemzes">Monotonit&#9500;&#237;s, sz&#9500;&#281;ls&#9532;&#313;&#9500;&#281;rt&#9500;&#281;k<span
                                        class="status grade-0" data-grade-for="fuggveny_jellemzes"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/paritas.html"
                                    data-topic-id="paritas">Parit&#225;s (p&#225;ros, p&#225;ratlan)<span class="status grade-0"
                                        data-grade-for="paritas"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/fuggveny_transzformaciok.html"
                                    data-topic-id="fuggveny_transzformaciok">F&#9500;&#9565;ggv&#9500;&#281;nytranszform&#9500;&#237;ci&#9500;&#9474;k<span
                                        class="status grade-0" data-grade-for="fuggveny_transzformaciok"></span></a>
                            </li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic"
                                data-src="modules/nevezetes_fuggvenyek_temazaro.html"
                                data-topic-id="nevezetes_fuggvenyek_temazaro">Nevezetes F&#9500;&#9565;ggv&#9500;&#281;nyek</a>
                            <span class="status grade-0" data-grade-for="nevezetes_fuggvenyek_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/linearis_fuggveny.html"
                                    data-topic-id="linearis_fuggveny">Line&#9500;&#237;ris f&#9500;&#9565;ggv&#9500;&#281;ny<span class="status grade-0"
                                        data-grade-for="linearis_fuggveny"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/masodfoku_fuggveny.html"
                                    data-topic-id="masodfoku_fuggveny">M&#9500;&#237;sodfok&#9500;&#9553; f&#9500;&#9565;ggv&#9500;&#281;ny<span class="status grade-0"
                                        data-grade-for="masodfoku_fuggveny"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/hatvanyfuggvenyek.html"
                                    data-topic-id="hatvanyfuggvenyek">Hatv&#9500;&#237;nyf&#9500;&#9565;ggv&#9500;&#281;nyek<span class="status grade-0"
                                        data-grade-for="hatvanyfuggvenyek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/exp_log_fuggveny.html"
                                    data-topic-id="exp_log_fuggveny">Exponenci&#9500;&#237;lis &#9500;&#281;s logaritmus fv.<span
                                        class="status grade-0" data-grade-for="exp_log_fuggveny"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/trigonometrikus_fuggvenyek.html"
                                    data-topic-id="trigonometrikus_fuggvenyek">Trigonometrikus fv.<span
                                        class="status grade-0" data-grade-for="trigonometrikus_fuggvenyek"></span></a>
                            </li>
                            <li><a href="#" class="module-link" data-src="modules/specialis_fuggvenyek.html"
                                    data-topic-id="specialis_fuggvenyek">Abszol&#9500;&#9553;t&#9500;&#281;rt&#9500;&#281;k, gy&#9500;&#194;k fv.<span
                                        class="status grade-0" data-grade-for="specialis_fuggvenyek"></span></a></li>
                        </ul>
                    </details>
                </details>

                <details>
                    <summary>
                        <a href="#" class="module-link main-topic" data-src="modules/geometria_modulzaro.html"
                            data-topic-id="geometria_modulzaro">&#173;&#269;&#346;&#9553;&#180;&#350;&#262; Geometria</a>
                        <span class="status grade-0" data-grade-for="geometria_modulzaro"></span>
                    </summary>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/haromszogek_temazaro.html"
                                data-topic-id="haromszogek_temazaro">Alapfogalmak &#9500;&#281;s H&#9500;&#237;romsz&#9500;&#194;gek</a>
                            <span class="status grade-0" data-grade-for="haromszogek_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/nevezetes_vonalak.html"
                                    data-topic-id="nevezetes_vonalak">Nevezetes vonalak<span class="status grade-0"
                                        data-grade-for="nevezetes_vonalak"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/haromszog_egyenlotlenseg.html"
                                    data-topic-id="haromszog_egyenlotlenseg">H&#9500;&#237;romsz&#9500;&#194;g-egyenl&#9532;&#313;tlens&#9500;&#281;g<span
                                        class="status grade-0" data-grade-for="haromszog_egyenlotlenseg"></span></a>
                            </li>
                            <li><a href="#" class="module-link" data-src="modules/szogtetelek.html"
                                    data-topic-id="szogtetelek">Pitagorasz, befog&#243;, magass&#225;g<span class="status grade-0"
                                        data-grade-for="szogtetelek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/szinusz_koszinusz_tetel.html"
                                    data-topic-id="szinusz_koszinusz_tetel">Szinuszt&#9500;&#281;tel, Koszinuszt&#9500;&#281;tel<span
                                        class="status grade-0" data-grade-for="szinusz_koszinusz_tetel"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/sokszogek_temazaro.html"
                                data-topic-id="sokszogek_temazaro">N&#9500;&#281;gysz&#9500;&#194;gek &#9500;&#281;s Soksz&#9500;&#194;gek</a>
                            <span class="status grade-0" data-grade-for="sokszogek_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/terulet_kerulet.html"
                                    data-topic-id="terulet_kerulet">Ter&#9500;&#9565;let- &#9500;&#281;s ker&#9500;&#9565;letsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s<span
                                        class="status grade-0" data-grade-for="terulet_kerulet"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/specialis_negyszogek.html"
                                    data-topic-id="specialis_negyszogek">H&#9500;&#9553;rn&#9500;&#281;gysz&#9500;&#194;gek, &#9500;&#281;rint&#9532;&#313;n&#9500;&#281;gysz&#9500;&#194;gek<span
                                        class="status grade-0" data-grade-for="specialis_negyszogek"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/kor_temazaro.html"
                                data-topic-id="kor_temazaro">A K&#9500;&#194;r</a>
                            <span class="status grade-0" data-grade-for="kor_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/keruleti_szogek.html"
                                    data-topic-id="keruleti_szogek">Ker&#9500;&#9565;leti &#9500;&#281;s k&#9500;&#194;z&#9500;&#281;pponti sz&#9500;&#194;gek<span
                                        class="status grade-0" data-grade-for="keruleti_szogek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/latokoriv.html"
                                    data-topic-id="latokoriv">L&#9500;&#237;t&#9500;&#9474;k&#9500;&#194;r&#9500;&#351;v<span class="status grade-0"
                                        data-grade-for="latokoriv"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/kor_helyzetek.html"
                                    data-topic-id="kor_helyzetek">K&#9500;&#194;r &#9500;&#281;s egyenes, k&#9500;&#194;r &#9500;&#281;s k&#9500;&#194;r<span class="status grade-0"
                                        data-grade-for="kor_helyzetek"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/geo_transzform_temazaro.html"
                                data-topic-id="geo_transzform_temazaro">Geometriai Transzform&#225;ci&#243;k</a>
                            <span class="status grade-0" data-grade-for="geo_transzform_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/tukrozes.html"
                                    data-topic-id="tukrozes">Tengelyes &#9500;&#281;s k&#9500;&#194;z&#9500;&#281;ppontos t&#9500;&#9565;kr&#9500;&#194;z&#9500;&#281;s<span
                                        class="status grade-0" data-grade-for="tukrozes"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/eltolas_forgatas.html"
                                    data-topic-id="eltolas_forgatas">Eltol&#225;s, elforgat&#225;s<span class="status grade-0"
                                        data-grade-for="eltolas_forgatas"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/hasonlosag.html"
                                    data-topic-id="hasonlosag">K&#9500;&#194;z&#9500;&#281;ppontos hasonl&#9500;&#9474;s&#9500;&#237;g<span class="status grade-0"
                                        data-grade-for="hasonlosag"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic"
                                data-src="modules/koordinatageometria_temazaro.html"
                                data-topic-id="koordinatageometria_temazaro">Koordin&#225;tageometria</a>
                            <span class="status grade-0" data-grade-for="koordinatageometria_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/vektorok.html"
                                    data-topic-id="vektorok">Vektorok (skal&#225;ris szorzat)<span class="status grade-0"
                                        data-grade-for="vektorok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/egyenes_egyenlete.html"
                                    data-topic-id="egyenes_egyenlete">Pont, szakasz, egyenes<span class="status grade-0"
                                        data-grade-for="egyenes_egyenlete"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/kor_egyenlete.html"
                                    data-topic-id="kor_egyenlete">K&#9500;&#194;r egyenlete<span class="status grade-0"
                                        data-grade-for="kor_egyenlete"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/alakzatok_metszespontja.html"
                                    data-topic-id="alakzatok_metszespontja">K&#9500;&#281;t alakzat metsz&#9500;&#281;spontja<span
                                        class="status grade-0" data-grade-for="alakzatok_metszespontja"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/tergeometria_temazaro.html"
                                data-topic-id="tergeometria_temazaro">T&#9500;&#281;rgeometria</a>
                            <span class="status grade-0" data-grade-for="tergeometria_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/hasabok_gulak.html"
                                    data-topic-id="hasabok_gulak">Has&#225;bok, g&#250;l&#225;k F, V<span class="status grade-0"
                                        data-grade-for="hasabok_gulak"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/forgastestek.html"
                                    data-topic-id="forgastestek">Forg&#9500;&#237;stestek (henger, k&#9500;&#9553;p, g&#9500;&#194;mb)<span
                                        class="status grade-0" data-grade-for="forgastestek"></span></a></li>
                        </ul>
                    </details>
                </details>

                <details>
                    <summary>
                        <a href="#" class="module-link main-topic" data-src="modules/valstat_modulzaro.html"
                            data-topic-id="valstat_modulzaro">&#173;&#269;&#196;&#9619; Val&#9500;&#9474;sz&#9500;&#351;n&#9532;&#9618;s&#9500;&#281;gsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s &#9500;&#281;s Statisztika</a>
                        <span class="status grade-0" data-grade-for="valstat_modulzaro"></span>
                    </summary>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/kombinatorika_temazaro.html"
                                data-topic-id="kombinatorika_temazaro">Kombinatorika</a>
                            <span class="status grade-0" data-grade-for="kombinatorika_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/permutaciok.html"
                                    data-topic-id="permutaciok">Permut&#225;ci&#243;k<span class="status grade-0"
                                        data-grade-for="permutaciok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/variaciok.html"
                                    data-topic-id="variaciok">Vari&#225;ci&#243;k<span class="status grade-0"
                                        data-grade-for="variaciok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/kombinaciok.html"
                                    data-topic-id="kombinaciok">Kombin&#225;ci&#243;k<span class="status grade-0"
                                        data-grade-for="kombinaciok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/binomialis_tetel.html"
                                    data-topic-id="binomialis_tetel">Binomi&#9500;&#237;lis t&#9500;&#281;tel<span class="status grade-0"
                                        data-grade-for="binomialis_tetel"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/valszam_temazaro.html"
                                data-topic-id="valszam_temazaro">Val&#9500;&#9474;sz&#9500;&#351;n&#9532;&#9618;s&#9500;&#281;gsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s</a>
                            <span class="status grade-0" data-grade-for="valszam_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/klasszikus_valoszinuseg.html"
                                    data-topic-id="klasszikus_valoszinuseg">Klasszikus val&#9500;&#9474;sz&#9500;&#351;n&#9532;&#9618;s&#9500;&#281;gi modell<span
                                        class="status grade-0" data-grade-for="klasszikus_valoszinuseg"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/geometriai_valoszinuseg.html"
                                    data-topic-id="geometriai_valoszinuseg">Geometriai val&#9500;&#9474;sz&#9500;&#351;n&#9532;&#9618;s&#9500;&#281;g<span
                                        class="status grade-0" data-grade-for="geometriai_valoszinuseg"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/felteteles_valoszinuseg.html"
                                    data-topic-id="felteteles_valoszinuseg">Felt&#9500;&#281;teles val&#9500;&#9474;sz&#9500;&#351;n&#9532;&#9618;s&#9500;&#281;g<span
                                        class="status grade-0" data-grade-for="felteteles_valoszinuseg"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/statisztika_temazaro.html"
                                data-topic-id="statisztika_temazaro">Statisztika</a>
                            <span class="status grade-0" data-grade-for="statisztika_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/adatok_abrazolasa.html"
                                    data-topic-id="adatok_abrazolasa">Adatok &#225;br&#225;zol&#225;sa<span class="status grade-0"
                                        data-grade-for="adatok_abrazolasa"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/kozepertekek.html"
                                    data-topic-id="kozepertekek">K&#9500;&#194;z&#9500;&#281;p&#9500;&#281;rt&#9500;&#281;kek<span class="status grade-0"
                                        data-grade-for="kozepertekek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/szorodas.html"
                                    data-topic-id="szorodas">Sz&#243;r&#243;d&#225;si mutat&#243;k<span class="status grade-0"
                                        data-grade-for="szorodas"></span></a></li>
                        </ul>
                    </details>
                </details>

                <details>
                    <summary>
                        <a href="#" class="module-link main-topic" data-src="modules/emelt_modulzaro.html"
                            data-topic-id="emelt_modulzaro">&#173;&#269;&#244;&#322; Emelt Szint&#9532;&#9618; Kieg&#9500;&#281;sz&#9500;&#351;t&#9500;&#281;sek</a>
                        <span class="status grade-0" data-grade-for="emelt_modulzaro"></span>
                    </summary>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/sorozatok_temazaro.html"
                                data-topic-id="sorozatok_temazaro">Sorozatok</a>
                            <span class="status grade-0" data-grade-for="sorozatok_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/szamtani_mertani.html"
                                    data-topic-id="szamtani_mertani">Sz&#9500;&#237;mtani &#9500;&#281;s m&#9500;&#281;rtani sorozatok<span
                                        class="status grade-0" data-grade-for="szamtani_mertani"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/kamatoskamat.html"
                                    data-topic-id="kamatoskamat">Kamatoskamat-sz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s<span class="status grade-0"
                                        data-grade-for="kamatoskamat"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/konvergencia.html"
                                    data-topic-id="konvergencia">Konvergencia<span class="status grade-0"
                                        data-grade-for="konvergencia"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/differencial_temazaro.html"
                                data-topic-id="differencial_temazaro">Differenci&#9500;&#237;lsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s</a>
                            <span class="status grade-0" data-grade-for="differencial_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/hatarertek.html"
                                    data-topic-id="hatarertek">Hat&#9500;&#237;r&#9500;&#281;rt&#9500;&#281;k, folytonoss&#9500;&#237;g<span class="status grade-0"
                                        data-grade-for="hatarertek"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/derivalt_fogalma.html"
                                    data-topic-id="derivalt_fogalma">A deriv&#225;lt fogalma<span class="status grade-0"
                                        data-grade-for="derivalt_fogalma"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/derivalasi_szabalyok.html"
                                    data-topic-id="derivalasi_szabalyok">Deriv&#225;l&#225;si szab&#225;lyok<span
                                        class="status grade-0" data-grade-for="derivalasi_szabalyok"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/fuggvenyvizsgalat.html"
                                    data-topic-id="fuggvenyvizsgalat">F&#9500;&#9565;ggv&#9500;&#281;nyvizsg&#9500;&#237;lat deriv&#9500;&#237;lttal<span
                                        class="status grade-0" data-grade-for="fuggvenyvizsgalat"></span></a></li>
                        </ul>
                    </details>
                    <details>
                        <summary>
                            <a href="#" class="module-link main-topic" data-src="modules/integral_temazaro.html"
                                data-topic-id="integral_temazaro">Integr&#9500;&#237;lsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s</a>
                            <span class="status grade-0" data-grade-for="integral_temazaro"></span>
                        </summary>
                        <ul>
                            <li><a href="#" class="module-link" data-src="modules/hatarozatlan_integral.html"
                                    data-topic-id="hatarozatlan_integral">A hat&#225;rozatlan integr&#225;l<span
                                        class="status grade-0" data-grade-for="hatarozatlan_integral"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/hatarozott_integral.html"
                                    data-topic-id="hatarozott_integral">A hat&#225;rozott integr&#225;l<span
                                        class="status grade-0" data-grade-for="hatarozott_integral"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/newton_leibniz.html"
                                    data-topic-id="newton_leibniz">Newton-Leibniz formula<span class="status grade-0"
                                        data-grade-for="newton_leibniz"></span></a></li>
                            <li><a href="#" class="module-link" data-src="modules/terfogatszamitas.html"
                                    data-topic-id="terfogatszamitas">T&#9500;&#281;rfogatsz&#9500;&#237;m&#9500;&#351;t&#9500;&#237;s integr&#9500;&#237;llal<span
                                        class="status grade-0" data-grade-for="terfogatszamitas"></span></a></li>
                        </ul>
                    </details>
                </details>

            </div>
        </nav>

        <main class="content">
            <div class="module-banner" id="module-banner" hidden>
                <div class="module-title" id="module-title">
                    <div class="module-title-text" id="module-title-text"></div>
                    <div class="module-subtitle" id="module-subtitle" hidden></div>
                </div>
            </div>
            <div class="module-stage">
                <div class="module-lock is-hidden" id="module-lock">
                    <div class="module-lock-content">
                        <p class="module-lock-title">Még nem elfogadott küldetés.</p>
                        <p class="module-lock-text">A folytatáshoz fogadd el a küldetést.</p>
                        <button class="quest-accept-btn" id="quest-accept-btn" type="button">Küldetés elfogadása</button>
                    </div>
                </div>
                <iframe id="content-frame" src="modules/placeholder.html" frameborder="0"></iframe>
            </div>
        </main>
    </div>
    
    <div class="sidebar-tooltip" id="sidebarTooltip"></div>
    </div>

    <button class="settings-fab" id="settings-fab" type="button" aria-haspopup="dialog" aria-controls="settings-overlay" aria-label="Beállítások">
        <span class="settings-fab-icon" aria-hidden="true">⚙</span>
    </button>

    <div class="settings-overlay is-hidden" id="settings-overlay" aria-hidden="true">
        <div class="settings-panel" id="settings-panel" role="dialog" aria-modal="true" aria-labelledby="settings-title">
            <div class="settings-header">
                <h2 id="settings-title">Beállítások</h2>
                <button class="icon-button settings-close" id="settings-close" type="button" aria-label="Bezárás">✕</button>
            </div>
            <div class="settings-body">
                <nav class="settings-categories" aria-label="Beállítás kategóriák">
                    <button class="settings-tab is-active" data-section="theme" type="button">Skin &amp; Téma</button>
                    <button class="settings-tab" data-section="ui" type="button">UI &amp; Hozzáférhetőség</button>
                    <button class="settings-tab" data-section="sound" type="button">Hang &amp; Visszajelzés</button>
                    <button class="settings-tab" data-section="gameplay" type="button">Játékélmény</button>
                </nav>
                <div class="settings-content">
                    <section class="settings-section is-active" data-section="theme">
                        <h3>Skin &amp; Téma</h3>
                        <p class="settings-hint">Válassz alap skint, majd finomhangold az egyéni színeket vagy háttérképet.</p>
                        <div class="settings-theme-grid" role="list">
                            <button class="theme-card" type="button" data-theme="pergamen" role="listitem">
                                <h4>Pergamen</h4>
                                <p>Meleg, klasszikus hangulat.</p>
                            </button>
                            <button class="theme-card" type="button" data-theme="galaxis" role="listitem">
                                <h4>Galaxis</h4>
                                <p>Mély kék, kozmikus akcentus.</p>
                            </button>
                            <button class="theme-card" type="button" data-theme="futurisztikus" role="listitem">
                                <h4>Futurisztikus</h4>
                                <p>Letisztult, neon jelleg.</p>
                            </button>
                            <button class="theme-card" type="button" data-theme="dark" role="listitem">
                                <h4>Sötét / Éjszakai</h4>
                                <p>Alacsony fény, fókuszált tanulás.</p>
                            </button>
                            <button class="theme-card" type="button" data-theme="custom" role="listitem">
                                <h4>Egyéni</h4>
                                <p>Saját színbeállításokkal.</p>
                            </button>
                        </div>

                        <div class="settings-group">
                            <h4>Egyéni színek</h4>
                            <div class="settings-field">
                                <label for="setting-sidebar-bg">Oldalsáv háttér</label>
                                <input type="color" id="setting-sidebar-bg" value="#1e2124">
                            </div>
                            <div class="settings-field">
                                <label for="setting-content-bg">Tartalom háttér</label>
                                <input type="color" id="setting-content-bg" value="#f6f7fb">
                            </div>
                            <div class="settings-field">
                                <label for="setting-button-bg">Elsődleges gomb</label>
                                <input type="color" id="setting-button-bg" value="#5865f2">
                            </div>
                            <div class="settings-field">
                                <label for="setting-button-text">Elsődleges szöveg</label>
                                <input type="color" id="setting-button-text" value="#ffffff">
                            </div>
                            <div class="settings-field">
                                <label for="setting-link-color">Hivatkozás színe</label>
                                <input type="color" id="setting-link-color" value="#b9bbbe">
                            </div>
                            <div class="settings-field">
                                <label for="setting-content-overlay">Tartalom fedőréteg</label>
                                <input type="text" id="setting-content-overlay" value="rgba(255, 255, 255, 0.8)" placeholder="rgba(255, 255, 255, 0.8)">
                            </div>
                            <div class="settings-field">
                                <label for="setting-content-overlay-alpha">Háttér fedőréteg erőssége</label>
                                <div class="settings-range">
                                    <input type="range" id="setting-content-overlay-alpha" min="0.35" max="0.9" step="0.05" value="0.8">
                                    <span class="range-value" id="setting-content-overlay-alpha-value">0.80</span>
                                </div>
                            </div>
                            <div class="settings-field">
                                <label for="setting-module-opacity">Tananyag panel áttetszőség</label>
                                <div class="settings-range">
                                    <input type="range" id="setting-module-opacity" min="0" max="1" step="0.05" value="1">
                                    <span class="range-value" id="setting-module-opacity-value">1.00</span>
                                </div>
                            </div>
                        </div>

                        <div class="settings-group">
                            <h4>Avatar</h4>
                            <div class="settings-field">
                                <label for="setting-avatar-file">Avatar feltöltése</label>
                                <input type="file" id="setting-avatar-file" accept="image/*">
                            </div>
                            <div class="avatar-preview" id="setting-avatar-preview">Nincs avatar kiválasztva.</div>
                        </div>

                        <div class="settings-group">
                            <h4>Háttérkép</h4>
                            <div class="settings-field">
                                <label for="setting-bg-file">Saját háttérkép feltöltése</label>
                                <input type="file" id="setting-bg-file" accept="image/*">
                            </div>
                            <div class="bg-preview" id="setting-bg-preview">Nincs háttérkép kiválasztva.</div>
                            <p class="settings-hint">A háttér mindig kap egy minimális fedőréteget az olvashatóságért.</p>
                        </div>
                    </section>

                    <section class="settings-section" data-section="ui">
                        <h3>UI &amp; Hozzáférhetőség</h3>
                        <div class="settings-group">
                            <div class="settings-field">
                                <label for="setting-font-scale">Betűméret</label>
                                <select id="setting-font-scale">
                                    <option value="100">Normál</option>
                                    <option value="110">Nagyobb</option>
                                    <option value="120">Nagyon nagy</option>
                                </select>
                            </div>
                            <div class="settings-field">
                                <label for="setting-reduce-motion">Animációk csökkentése</label>
                                <input type="checkbox" id="setting-reduce-motion">
                            </div>
                        </div>
                        <p class="settings-hint">A változások mentés után érvényesülnek.</p>
                    </section>

                    <section class="settings-section" data-section="sound">
                        <h3>Hang &amp; Visszajelzés</h3>
                        <p class="settings-hint">Hamarosan elérhető.</p>
                    </section>

                    <section class="settings-section" data-section="gameplay">
                        <h3>Játékélmény &amp; Segítség</h3>
                        <p class="settings-hint">Hamarosan elérhető.</p>
                    </section>
                </div>
            </div>
            <div class="settings-footer">
                <button class="settings-btn secondary" id="settings-cancel" type="button">Mégse</button>
                <button class="settings-btn primary" id="settings-save" type="button">Mentés</button>
            </div>
        </div>
    </div>

    <script>
        const allLinks = document.querySelectorAll('.module-link');
        const contentLinks = Array.from(allLinks).filter(link => !link.classList.contains('results-btn'));
        const iframe = document.getElementById('content-frame');
        const tooltip = document.getElementById('sidebarTooltip');
        const resultsBtn = document.getElementById('results-btn');
        const xpLevelLabel = document.getElementById('xp-level-label');
        const xpLevelName = document.getElementById('xp-level-name');
        const xpTotalLabel = document.getElementById('xp-total-label');
        const xpBar = document.getElementById('xp-bar');
        const xpBarFill = document.getElementById('xp-bar-fill');
        const xpProgressText = document.getElementById('xp-progress-text');
        const NUMBER_FORMATTER = new Intl.NumberFormat('hu-HU', { maximumFractionDigits: 2 });
        const playerAvatar = document.getElementById('player-avatar');
        const questToggle = document.getElementById('quest-toggle');
        const questBackdrop = document.getElementById('quest-drawer-backdrop');
        const moduleBanner = document.getElementById('module-banner');
        const moduleTitleText = document.getElementById('module-title-text');
        const moduleSubtitle = document.getElementById('module-subtitle');
        const questAcceptBtn = document.getElementById('quest-accept-btn');
        const moduleLock = document.getElementById('module-lock');
        const settingsFab = document.getElementById('settings-fab');
        const settingsOverlay = document.getElementById('settings-overlay');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const settingsCancel = document.getElementById('settings-cancel');
        const settingsSave = document.getElementById('settings-save');
        const settingsTabs = document.querySelectorAll('.settings-tab');
        const settingsSections = document.querySelectorAll('.settings-section');
        const themeCards = document.querySelectorAll('.theme-card');
        const settingSidebarBg = document.getElementById('setting-sidebar-bg');
        const settingContentBg = document.getElementById('setting-content-bg');
        const settingButtonBg = document.getElementById('setting-button-bg');
        const settingButtonText = document.getElementById('setting-button-text');
        const settingLinkColor = document.getElementById('setting-link-color');
        const settingContentOverlay = document.getElementById('setting-content-overlay');
        const settingContentOverlayAlpha = document.getElementById('setting-content-overlay-alpha');
        const settingContentOverlayAlphaValue = document.getElementById('setting-content-overlay-alpha-value');
        const settingModuleOpacity = document.getElementById('setting-module-opacity');
        const settingModuleOpacityValue = document.getElementById('setting-module-opacity-value');
        const settingAvatarFile = document.getElementById('setting-avatar-file');
        const settingAvatarPreview = document.getElementById('setting-avatar-preview');
        const settingBgFile = document.getElementById('setting-bg-file');
        const settingBgPreview = document.getElementById('setting-bg-preview');
        const settingFontScale = document.getElementById('setting-font-scale');
        const settingReduceMotion = document.getElementById('setting-reduce-motion');
        const QUEST_STORAGE_KEY = 'matek-mester-quests-v1';
        const QUEST_VERSION = 2;
        const QUEST_LEVELS = { MAIN: 'mainTopics', SUB: 'subtopics', TOPIC: 'topics' };
        const QUEST_STATUS = {
            NOT_ACCEPTED: 'NOT_ACCEPTED',
            ACTIVE: 'ACTIVE',
            COMPLETED: 'COMPLETED'
        };
        const QUEST_STATUS_LABELS = {
            NOT_ACCEPTED: 'Még nem elfogadott küldetés',
            ACTIVE: 'Aktív küldetés',
            COMPLETED: 'Kimaxolt küldetés'
        };
        const QUEST_STATUS_ORDER = {
            NOT_ACCEPTED: 0,
            ACTIVE: 1,
            COMPLETED: 2
        };
        const QUEST_EXCLUDED_TOPICS = new Set(['settings']);
        const QUEST_HIERARCHY = buildQuestHierarchy();
        const QUEST_INDEX = QUEST_HIERARCHY.index;
        const SHEET_BANNER_MAP = {
            'modules/character_sheet.html': {
                title: 'Karakterlap',
                subtitle: 'Rövid áttekintés a szintedről, küldetésekről és eredményekről.'
            },
            'modules/results.html': {
                title: 'Eredményeim',
                subtitle: ''
            }
        };
        const moduleSheetSubtitles = {};
        const SETTINGS_MIN_OVERLAY_ALPHA = 0.35;
        const SETTINGS_MAX_OVERLAY_ALPHA = 0.9;
        const RNG_SEED_STORAGE_KEY = 'matek-mester-rng-seed';
        let seededRandomSeed = null;

        function createSeededRandom(seed) {
            let t = seed >>> 0;
            return () => {
                t += 0x6D2B79F5;
                let r = Math.imul(t ^ (t >>> 15), 1 | t);
                r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
                return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
            };
        }

        function readSeedFromStorage() {
            try {
                const stored = localStorage.getItem(RNG_SEED_STORAGE_KEY);
                if (!stored) return null;
                const value = Number(stored);
                return Number.isFinite(value) ? value : null;
            } catch (error) {
                return null;
            }
        }

        function getSeedValue() {
            if (Number.isFinite(seededRandomSeed)) return seededRandomSeed;
            return readSeedFromStorage();
        }

        function applySeededRandom(targetWindow) {
            const seed = getSeedValue();
            if (!targetWindow || seed === null) return;
            if (targetWindow.__matekSeededRandomSeed !== seed) {
                targetWindow.__matekSeededRandomSeed = seed;
                targetWindow.__matekSeededRandom = createSeededRandom(seed);
            }
            targetWindow.Math.random = targetWindow.__matekSeededRandom;
        }

        function setSeededRandom(seed) {
            const value = Number(seed);
            if (!Number.isFinite(value)) return;
            seededRandomSeed = value;
            try {
                localStorage.setItem(RNG_SEED_STORAGE_KEY, String(value));
            } catch (error) {
                // Ignore storage failures (e.g. blocked localStorage).
            }
            applySeededRandom(window);
            if (iframe && iframe.contentWindow) {
                applySeededRandom(iframe.contentWindow);
            }
        }

        const storedSeed = readSeedFromStorage();
        if (storedSeed !== null) {
            seededRandomSeed = storedSeed;
            applySeededRandom(window);
        }
        window.__setMatekSeed = setSeededRandom;

        function formatNumber(value, fallback = '0') {
            if (value === null || value === undefined || value === '') return fallback;
            const num = Number(value);
            return Number.isFinite(num) ? NUMBER_FORMATTER.format(num) : fallback;
        }
        const THEME_TOKENS = {
            pergamen: {
                themeId: 'pergamen',
                sidebarBg: '#2f2a24',
                contentBg: '#f6f1e7',
                buttonBg: '#9b6b3d',
                buttonText: '#ffffff',
                linkColor: '#d9c4a4',
                contentOverlay: 'rgba(248, 242, 228, 0.75)',
                headerBg: '#2a251f',
                headerBorder: '#4a3c2a',
                xpBarBg: '#1d1a17',
                xpBarFill: 'linear-gradient(90deg, #c88d4a, #f2c37c)',
                xpBarTick: 'rgba(255, 255, 255, 0.12)',
                buffBg: '#4a3c2a',
                buffBorder: 'rgba(255, 255, 255, 0.2)',
                avatarBg: '#5b4632',
                titleColor: '#f6f1e7'
            },
            galaxis: {
                themeId: 'galaxis',
                sidebarBg: '#141525',
                contentBg: '#f5f7fb',
                buttonBg: '#4f46e5',
                buttonText: '#ffffff',
                linkColor: '#9ea7ff',
                contentOverlay: 'rgba(18, 20, 38, 0.7)',
                headerBg: '#111326',
                headerBorder: '#262a4d',
                xpBarBg: '#0d0f1f',
                xpBarFill: 'linear-gradient(90deg, #5b5cff, #9f7bff)',
                xpBarTick: 'rgba(255, 255, 255, 0.1)',
                buffBg: '#232548',
                buffBorder: 'rgba(255, 255, 255, 0.2)',
                avatarBg: '#2a2e5b',
                titleColor: '#f3f4ff'
            },
            futurisztikus: {
                themeId: 'futurisztikus',
                sidebarBg: '#1a1f26',
                contentBg: '#f4f7fb',
                buttonBg: '#19c37d',
                buttonText: '#0b1016',
                linkColor: '#7bdac0',
                contentOverlay: 'rgba(235, 240, 244, 0.75)',
                headerBg: '#12161b',
                headerBorder: '#2b333d',
                xpBarBg: '#0f1419',
                xpBarFill: 'linear-gradient(90deg, #19c37d, #4fd5ff)',
                xpBarTick: 'rgba(255, 255, 255, 0.12)',
                buffBg: '#24303a',
                buffBorder: 'rgba(255, 255, 255, 0.18)',
                avatarBg: '#2c3944',
                titleColor: '#e6f6f2'
            },
            dark: {
                themeId: 'dark',
                sidebarBg: '#1e2124',
                contentBg: '#f5f7fb',
                buttonBg: '#5865f2',
                buttonText: '#ffffff',
                linkColor: '#b9bbbe',
                contentOverlay: 'rgba(15, 18, 22, 0.7)',
                headerBg: '#181b1f',
                headerBorder: '#2a2e34',
                xpBarBg: '#101215',
                xpBarFill: 'linear-gradient(90deg, #7c5cff, #a855f7)',
                xpBarTick: 'rgba(255, 255, 255, 0.08)',
                buffBg: '#2a2e34',
                buffBorder: 'rgba(255, 255, 255, 0.12)',
                avatarBg: '#3b4047',
                titleColor: '#f5f6f7'
            }
        };
        let progressData = {};
        let questState = loadQuestState();
        let currentTopicId = null;
        let lockedTopicId = null;
        let lockedModuleSrc = null;
        let sheetBannerActive = false;
        let activeSettings = null;
        let draftSettings = null;
        let lastFocusedElement = null;

        function setActiveLink(activeLink) { allLinks.forEach(l => l.classList.remove('active')); if(activeLink) { activeLink.classList.add('active'); } }

        function getDefaultSettings() {
            return {
                ...THEME_TOKENS.dark,
                themeId: 'dark',
                contentBgImage: 'none',
                avatarImage: '',
                moduleCardOpacity: 1,
                reduceMotion: false,
                fontScale: 100
            };
        }
        function clampOverlayAlpha(value) {
            if (!Number.isFinite(value)) return SETTINGS_MIN_OVERLAY_ALPHA;
            return Math.min(SETTINGS_MAX_OVERLAY_ALPHA, Math.max(SETTINGS_MIN_OVERLAY_ALPHA, value));
        }

        function parseOverlayColor(value) {
            const fallback = { r: 15, g: 18, b: 22, a: SETTINGS_MIN_OVERLAY_ALPHA };
            if (!value || typeof value !== 'string') return fallback;
            const trimmed = value.trim();
            const rgbaMatch = trimmed.match(/^rgba?\(([^)]+)\)$/i);
            if (rgbaMatch) {
                const parts = rgbaMatch[1].split(',').map(part => part.trim());
                const r = Number(parts[0]);
                const g = Number(parts[1]);
                const b = Number(parts[2]);
                if ([r, g, b].some(Number.isNaN)) return fallback;
                const alpha = parts.length > 3 ? Number(parts[3]) : SETTINGS_MIN_OVERLAY_ALPHA;
                return { r, g, b, a: Number.isNaN(alpha) ? SETTINGS_MIN_OVERLAY_ALPHA : alpha };
            }
            const hexMatch = trimmed.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hexMatch) {
                const hex = hexMatch[1];
                const full = hex.length === 3 ? hex.split('').map(ch => ch + ch).join('') : hex;
                const r = parseInt(full.slice(0, 2), 16);
                const g = parseInt(full.slice(2, 4), 16);
                const b = parseInt(full.slice(4, 6), 16);
                return { r, g, b, a: SETTINGS_MIN_OVERLAY_ALPHA };
            }
            return fallback;
        }

        function formatOverlayColor(color) {
            return `rgba(${color.r}, ${color.g}, ${color.b}, ${color.a})`;
        }

        function normalizeOverlayColor(value) {
            const parsed = parseOverlayColor(value);
            return formatOverlayColor({ ...parsed, a: clampOverlayAlpha(parsed.a) });
        }

        function getOverlayAlpha(value) {
            const parsed = parseOverlayColor(value);
            return clampOverlayAlpha(parsed.a);
        }

        function applyOverlayAlpha(value, alpha) {
            const parsed = parseOverlayColor(value);
            return formatOverlayColor({ ...parsed, a: clampOverlayAlpha(alpha) });
        }
        function parseHexColor(hex) {
            const match = (hex || '').trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (!match) return null;
            const raw = match[1];
            const full = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
            return {
                r: parseInt(full.slice(0, 2), 16),
                g: parseInt(full.slice(2, 4), 16),
                b: parseInt(full.slice(4, 6), 16)
            };
        }

        function parseRgbColor(value) {
            const match = (value || '').trim().match(/^rgba?\(([^)]+)\)$/i);
            if (!match) return null;
            const parts = match[1].split(',').map(part => part.trim());
            if (parts.length < 3) return null;
            const r = Number(parts[0]);
            const g = Number(parts[1]);
            const b = Number(parts[2]);
            if ([r, g, b].some(Number.isNaN)) return null;
            return { r, g, b };
        }

        function isDarkColor(value) {
            const rgb = parseHexColor(value) || parseRgbColor(value);
            if (!rgb) return false;
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            return luminance < 0.5;
        }

        function rgbaFromHex(hex, alpha) {
            const rgb = parseHexColor(hex);
            if (!rgb) return '';
            return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${alpha})`;
        }

        function lightenHexColor(hex, amount) {
            const rgb = parseHexColor(hex);
            if (!rgb) return '';
            const r = Math.round(rgb.r + (255 - rgb.r) * amount);
            const g = Math.round(rgb.g + (255 - rgb.g) * amount);
            const b = Math.round(rgb.b + (255 - rgb.b) * amount);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function buildModuleThemeTokens(settings) {
            const contentBg = settings.contentBg || '#f5f7fb';
            const dark = isDarkColor(contentBg);
            const primary = settings.buttonBg || '#5865f2';
            const secondary = settings.linkColor || '#b9bbbe';
            const brandBackground = rgbaFromHex(primary, 0.22);
            const brandLight = lightenHexColor(primary, 0.4) || secondary;
            const cardBase = dark ? '20, 24, 30' : '255, 255, 255';
            return {
                '--brand-primary': primary,
                '--brand-secondary': secondary,
                '--brand-light': brandLight,
                '--brand-background': brandBackground || '',
                '--bg-main': contentBg,
                '--bg-card': `rgba(${cardBase}, ${settings.moduleCardOpacity})`,
                '--border-color': dark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(15, 23, 42, 0.1)',
                '--text-dark': dark ? '#f3f4f6' : '#2c3333',
                '--text-light': dark ? '#d1d5db' : '#393e46'
            };
        }

        function normalizeSettings(settings) {
            const base = getDefaultSettings();
            const merged = { ...base, ...(settings || {}) };
            merged.contentBgImage = merged.contentBgImage || 'none';
            merged.avatarImage = merged.avatarImage || '';
            merged.contentOverlay = normalizeOverlayColor(merged.contentOverlay);
            const opacityValue = Number(merged.moduleCardOpacity);
            merged.moduleCardOpacity = Number.isFinite(opacityValue)
                ? Math.min(1, Math.max(0, opacityValue))
                : 1;
            return merged;
        }

        function applySettings(settings) {
            const normalized = normalizeSettings(settings);
            const root = document.documentElement;
            root.style.setProperty('--sidebar-bg', normalized.sidebarBg);
            root.style.setProperty('--content-bg', normalized.contentBg);
            root.style.setProperty('--content-bg-image', normalized.contentBgImage);
            root.style.setProperty('--button-bg', normalized.buttonBg);
            root.style.setProperty('--button-text', normalized.buttonText);
            root.style.setProperty('--link-color', normalized.linkColor);
            root.style.setProperty('--content-overlay', normalized.contentOverlay);
            root.style.setProperty('--module-card-opacity', normalized.moduleCardOpacity);
            if (normalized.headerBg) root.style.setProperty('--header-bg', normalized.headerBg);
            if (normalized.headerBorder) root.style.setProperty('--header-border', normalized.headerBorder);
            if (normalized.xpBarBg) root.style.setProperty('--xp-bar-bg', normalized.xpBarBg);
            if (normalized.xpBarFill) root.style.setProperty('--xp-bar-fill', normalized.xpBarFill);
            if (normalized.xpBarTick) root.style.setProperty('--xp-bar-tick', normalized.xpBarTick);
            if (normalized.buffBg) root.style.setProperty('--buff-bg', normalized.buffBg);
            if (normalized.buffBorder) root.style.setProperty('--buff-border', normalized.buffBorder);
            if (normalized.avatarBg) root.style.setProperty('--avatar-bg', normalized.avatarBg);
            if (normalized.titleColor) root.style.setProperty('--title-color', normalized.titleColor);
            if (normalized.avatarImage) {
                root.style.setProperty('--avatar-image', normalized.avatarImage);
            } else {
                root.style.removeProperty('--avatar-image');
            }
            const content = document.querySelector('.content');
            if (content) {
                content.style.backgroundColor = normalized.contentBg;
                content.style.backgroundImage = normalized.contentBgImage;
                content.style.backgroundSize = 'cover';
                content.style.backgroundPosition = 'center';
            }
            root.style.fontSize = normalized.fontScale ? `${normalized.fontScale}%` : '';
            document.body.classList.toggle('reduce-motion', Boolean(normalized.reduceMotion));
            applySettingsToIframe(normalized);
        }

        function applySettingsToIframe(settings) {
            if (!iframe || !iframe.contentDocument) return;
            const normalized = normalizeSettings(settings);
            const doc = iframe.contentDocument;
            const root = doc.documentElement;
            root.style.setProperty('--module-card-opacity', normalized.moduleCardOpacity);
            root.style.setProperty('--content-bg', normalized.contentBg);
            root.style.setProperty('--content-bg-image', normalized.contentBgImage);
            root.style.setProperty('--content-overlay', normalized.contentOverlay);
            root.style.setProperty('--button-bg', normalized.buttonBg);
            root.style.setProperty('--button-text', normalized.buttonText);
            root.style.setProperty('--link-color', normalized.linkColor);
            root.style.setProperty('--accent-color', normalized.buttonBg);
            root.style.backgroundColor = 'transparent';
            root.style.backgroundImage = 'none';
            root.style.fontSize = normalized.fontScale ? `${normalized.fontScale}%` : '';
            const moduleTokens = buildModuleThemeTokens(normalized);
            Object.entries(moduleTokens).forEach(([key, value]) => {
                if (value) {
                    root.style.setProperty(key, value);
                }
            });
            if (doc.body) {
                doc.body.style.backgroundColor = 'transparent';
                doc.body.style.backgroundImage = 'none';
                doc.body.classList.toggle('reduce-motion', Boolean(normalized.reduceMotion));
            }
            ensureModuleResponsiveStyles(doc);
        }

        const MODULE_RESPONSIVE_STYLE_ID = 'module-responsive-overrides';

        function ensureModuleResponsiveStyles(doc) {
            if (!doc) return;
            const existing = doc.getElementById(MODULE_RESPONSIVE_STYLE_ID);
            if (existing) return;
            const style = doc.createElement('style');
            style.id = MODULE_RESPONSIVE_STYLE_ID;
            style.textContent = `
*,
*::before,
*::after {
    box-sizing: border-box;
}
img,
svg,
canvas,
video {
    max-width: 100%;
    height: auto;
}
table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
}
pre,
code,
.katex-display {
    max-width: 100%;
    overflow-x: auto;
}
input,
textarea,
select,
button {
    max-width: 100%;
}
@media (max-width: 767px) {
    body {
        padding: 28px 20px;
        overflow-x: hidden;
    }
    .card,
    .module-card,
    .model-card,
    .result-item,
    .xp-summary,
    .modal-content {
        padding: 20px;
    }
    .tab-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 6px;
    }
    .tab-button {
        flex: 1 1 auto;
        min-width: 0;
        padding: 10px 14px;
        font-size: 0.95rem;
    }
    .model-container,
    .theory-grid,
    .stats-grid,
    .sheet,
    .tabs {
        grid-template-columns: 1fr;
    }
    .result-item {
        grid-template-columns: 1fr;
        align-items: start;
    }
    .result-actions {
        justify-self: start;
    }
}
@media (max-width: 480px) {
    body {
        padding: 22px 16px;
    }
    h1 {
        font-size: 2rem;
    }
    h2 {
        font-size: 1.5em;
    }
    h3 {
        font-size: 1.05em;
    }
    p,
    li,
    label {
        font-size: 1rem;
    }
    .card,
    .module-card,
    .model-card,
    .result-item,
    .xp-summary,
    .modal-content {
        padding: 18px;
    }
    .tab-button {
        min-width: 110px;
        padding: 9px 12px;
        font-size: 0.9rem;
    }
    .grade-badge {
        width: 48px;
        height: 48px;
        font-size: 1.4em;
    }
    .result-details h3 {
        font-size: 1.05em;
    }
}
            `.trim();
            const target = doc.head || doc.body;
            if (target) {
                target.appendChild(style);
            }
        }

        function broadcastSettings(settings) {
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'apply-settings', settings }, '*');
            }
        }

        function setActiveSettings(settings) {
            activeSettings = normalizeSettings(settings);
            draftSettings = { ...activeSettings };
            applySettings(activeSettings);
            broadcastSettings(activeSettings);
        }

        function setThemeSelection(themeId) {
            themeCards.forEach(card => {
                card.classList.toggle('selected', card.dataset.theme === themeId);
            });
        }

        function syncSettingsUI(settings) {
            if (!settings) return;
            setThemeSelection(settings.themeId || 'custom');
            if (settingSidebarBg) settingSidebarBg.value = settings.sidebarBg;
            if (settingContentBg) settingContentBg.value = settings.contentBg;
            if (settingButtonBg) settingButtonBg.value = settings.buttonBg;
            if (settingButtonText) settingButtonText.value = settings.buttonText;
            if (settingLinkColor) settingLinkColor.value = settings.linkColor;
            if (settingContentOverlay) settingContentOverlay.value = settings.contentOverlay;
            const overlayAlpha = getOverlayAlpha(settings.contentOverlay);
            if (settingContentOverlayAlpha) settingContentOverlayAlpha.value = String(overlayAlpha);
            if (settingContentOverlayAlphaValue) settingContentOverlayAlphaValue.textContent = overlayAlpha.toFixed(2);
            if (settingModuleOpacity) settingModuleOpacity.value = String(settings.moduleCardOpacity ?? 1);
            if (settingModuleOpacityValue) {
                settingModuleOpacityValue.textContent = Number(settings.moduleCardOpacity ?? 1).toFixed(2);
            }
            if (settingFontScale) settingFontScale.value = String(settings.fontScale || 100);
            if (settingReduceMotion) settingReduceMotion.checked = Boolean(settings.reduceMotion);
            if (settingAvatarPreview) {
                if (settings.avatarImage) {
                    settingAvatarPreview.style.backgroundImage = settings.avatarImage;
                    settingAvatarPreview.textContent = '';
                } else {
                    settingAvatarPreview.style.backgroundImage = 'none';
                    settingAvatarPreview.textContent = 'Nincs avatar kiválasztva.';
                }
            }
            if (settingBgPreview) {
                if (settings.contentBgImage && settings.contentBgImage !== 'none') {
                    settingBgPreview.style.backgroundImage = settings.contentBgImage;
                    settingBgPreview.textContent = '';
                } else {
                    settingBgPreview.style.backgroundImage = 'none';
                    settingBgPreview.textContent = 'Nincs háttérkép kiválasztva.';
                }
            }
        }

        function updateSettingsDraft(next) {
            const base = draftSettings || activeSettings || getDefaultSettings();
            draftSettings = normalizeSettings({ ...base, ...next });
            applySettings(draftSettings);
        }

        function openSettingsOverlay() {
            if (!settingsOverlay) return;
            lastFocusedElement = document.activeElement;
            if (!draftSettings) {
                draftSettings = { ...(activeSettings || getDefaultSettings()) };
            }
            syncSettingsUI(draftSettings);
            settingsOverlay.classList.remove('is-hidden');
            settingsOverlay.setAttribute('aria-hidden', 'false');
            document.body.classList.add('settings-open');
            const focusTarget = settingsTabs && settingsTabs.length ? settingsTabs[0] : settingsClose;
            if (focusTarget) {
                focusTarget.focus();
            }
        }

        function closeSettingsOverlay(resetDraft = true) {
            if (!settingsOverlay) return;
            settingsOverlay.classList.add('is-hidden');
            settingsOverlay.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('settings-open');
            if (resetDraft && activeSettings) {
                draftSettings = { ...activeSettings };
                applySettings(activeSettings);
                broadcastSettings(activeSettings);
            }
            if (lastFocusedElement && typeof lastFocusedElement.focus === 'function') {
                lastFocusedElement.focus();
            }
        }

        function openCharacterSheet() {
            setActiveLink(null);
            updateModuleBanner(null);
            unlockModule();
            if (iframe) {
                iframe.src = 'modules/character_sheet.html';
            }
        }

        function createQuestState() {
            return { version: QUEST_VERSION, mainTopics: {}, subtopics: {}, topics: {} };
        }

        function coerceQuestState(raw) {
            const normalized = createQuestState();
            if (!raw || typeof raw !== 'object') {
                return normalized;
            }
            const versionNumber = Number(raw.version);
            if (Number.isFinite(versionNumber) && versionNumber > 0) {
                normalized.version = versionNumber;
            }
            if (raw.mainTopics && typeof raw.mainTopics === 'object') {
                normalized.mainTopics = { ...raw.mainTopics };
            }
            if (raw.subtopics && typeof raw.subtopics === 'object') {
                normalized.subtopics = { ...raw.subtopics };
            }
            if (raw.topics && typeof raw.topics === 'object') {
                normalized.topics = { ...raw.topics };
            }
            return normalized;
        }

        function buildQuestHierarchy() {
            const hierarchy = { mainTopics: {} };
            const index = {
                mainIds: new Set(),
                subIds: new Set(),
                topicIds: new Set(),
                topicToSub: {},
                subToMain: {}
            };
            const mainDetails = document.querySelectorAll('.module-list > details');
            mainDetails.forEach((mainDetail) => {
                const mainLink = mainDetail.querySelector(':scope > summary a[data-topic-id]');
                if (!mainLink) return;
                const mainId = mainLink.getAttribute('data-topic-id');
                if (!mainId) return;
                index.mainIds.add(mainId);
                const subtopics = {};
                const subDetails = mainDetail.querySelectorAll(':scope > details');
                subDetails.forEach((subDetail) => {
                    const subLink = subDetail.querySelector(':scope > summary a[data-topic-id]');
                    if (!subLink) return;
                    const subId = subLink.getAttribute('data-topic-id');
                    if (!subId) return;
                    index.subIds.add(subId);
                    index.subToMain[subId] = mainId;
                    const topicLinks = subDetail.querySelectorAll(':scope > ul > li > a[data-topic-id]');
                    const topics = Array.from(topicLinks)
                        .map(link => link.getAttribute('data-topic-id'))
                        .filter(Boolean);
                    topics.forEach((topicId) => {
                        index.topicIds.add(topicId);
                        index.topicToSub[topicId] = subId;
                    });
                    subtopics[subId] = { topics };
                });
                hierarchy.mainTopics[mainId] = { subtopics };
            });

            const allLinks = document.querySelectorAll('.module-link[data-topic-id]');
            allLinks.forEach((link) => {
                const id = link.getAttribute('data-topic-id');
                if (!id) return;
                if (index.mainIds.has(id) || index.subIds.has(id) || index.topicIds.has(id)) return;
                index.topicIds.add(id);
            });

            return { hierarchy, index };
        }

        function getQuestType(topicId) {
            if (!topicId) return QUEST_LEVELS.TOPIC;
            if (QUEST_INDEX.mainIds.has(topicId)) return QUEST_LEVELS.MAIN;
            if (QUEST_INDEX.subIds.has(topicId)) return QUEST_LEVELS.SUB;
            if (QUEST_INDEX.topicIds.has(topicId)) return QUEST_LEVELS.TOPIC;
            return QUEST_LEVELS.TOPIC;
        }

        function getQuestMap(type) {
            if (!questState || typeof questState !== 'object') {
                questState = createQuestState();
            }
            if (!questState[type] || typeof questState[type] !== 'object') {
                questState[type] = {};
            }
            return questState[type];
        }

        function mergeQuestMaps(target, source) {
            const result = { ...target };
            Object.entries(source || {}).forEach(([id, status]) => {
                if (!isQuestableTopic(id)) return;
                const current = result[id];
                if (!current || QUEST_STATUS_ORDER[status] > QUEST_STATUS_ORDER[current]) {
                    result[id] = status;
                }
            });
            return result;
        }

        function mergeQuestState(base, incoming) {
            const normalizedBase = coerceQuestState(base);
            const normalizedIncoming = coerceQuestState(incoming);
            return {
                version: Math.max(normalizedBase.version || QUEST_VERSION, normalizedIncoming.version || QUEST_VERSION),
                mainTopics: mergeQuestMaps(normalizedBase.mainTopics, normalizedIncoming.mainTopics),
                subtopics: mergeQuestMaps(normalizedBase.subtopics, normalizedIncoming.subtopics),
                topics: mergeQuestMaps(normalizedBase.topics, normalizedIncoming.topics)
            };
        }
        function loadQuestState() {
            try {
                const raw = localStorage.getItem(QUEST_STORAGE_KEY);
                if (!raw) {
                    return createQuestState();
                }
                const parsed = JSON.parse(raw);
                return coerceQuestState(parsed);
            } catch (error) {
                return createQuestState();
            }
        }

        function saveQuestState() {
            questState = coerceQuestState(questState);
            try {
                localStorage.setItem(QUEST_STORAGE_KEY, JSON.stringify(questState));
            } catch (error) {
                console.error('Nem sikerult a quest allapot mentese:', error);
            }
            if (window.electronAPI && typeof window.electronAPI.saveQuestState === 'function') {
                try {
                    window.electronAPI.saveQuestState(questState);
                } catch (error) {
                    console.error('Nem sikerult a quest allapot szinkron:', error);
                }
            }
        }

        function isQuestableTopic(topicId) {
            return Boolean(topicId && !QUEST_EXCLUDED_TOPICS.has(topicId));
        }

        function getQuestStatus(topicId, questType) {
            const type = questType || getQuestType(topicId);
            const map = getQuestMap(type);
            const status = map ? map[topicId] : null;
            if (status === QUEST_STATUS.ACTIVE || status === QUEST_STATUS.COMPLETED || status === QUEST_STATUS.NOT_ACCEPTED) {
                return status;
            }
            return QUEST_STATUS.NOT_ACCEPTED;
        }

        function getQuestStatusLabel(status) {
            return QUEST_STATUS_LABELS[status] || '';
        }

        function setQuestStatus(topicId, nextStatus, options = {}) {
            if (!isQuestableTopic(topicId)) return;
            const questType = options.type || getQuestType(topicId);
            const current = getQuestStatus(topicId, questType);
            if (QUEST_STATUS_ORDER[nextStatus] < QUEST_STATUS_ORDER[current]) return;
            if (current === nextStatus) return;
            const map = getQuestMap(questType);
            map[topicId] = nextStatus;
            if (options.persist !== false) {
                saveQuestState();
            }
            const link = document.querySelector(`[data-topic-id="${topicId}"]`);
            if (link) {
                applyQuestStatusToLink(link);
            }
            if (currentTopicId === topicId) {
                updateModuleBanner(link);
            }
            maybeUnlockContent(topicId);
        }

        function applyQuestStatusToLink(link) {
            const topicId = link.getAttribute('data-topic-id');
            const statusCircle = topicId
                ? document.querySelector(`.status[data-grade-for="${topicId}"]`)
                : null;
            if (!isQuestableTopic(topicId)) {
                link.removeAttribute('data-quest-status');
                link.removeAttribute('data-quest-status-label');
                link.removeAttribute('title');
                link.removeAttribute('aria-label');
                if (statusCircle) {
                    statusCircle.removeAttribute('data-quest-status');
                }
                return;
            }
            const status = getQuestStatus(topicId, getQuestType(topicId));
            const statusLabel = getQuestStatusLabel(status);
            link.setAttribute('data-quest-status', status);
            link.setAttribute('data-quest-status-label', statusLabel);
            if (statusLabel) {
                link.setAttribute('title', statusLabel);
                link.setAttribute('aria-label', `${getLinkLabel(link)} - ${statusLabel}`);
            } else {
                link.removeAttribute('title');
                link.removeAttribute('aria-label');
            }
            if (statusCircle) {
                statusCircle.setAttribute('data-quest-status', status);
            }
        }

        function ensureQuestDefaults() {
            questState = coerceQuestState(questState);
            QUEST_INDEX.mainIds.forEach((topicId) => {
                if (!isQuestableTopic(topicId)) return;
                const map = getQuestMap(QUEST_LEVELS.MAIN);
                if (!map[topicId]) {
                    map[topicId] = QUEST_STATUS.NOT_ACCEPTED;
                }
            });
            QUEST_INDEX.subIds.forEach((topicId) => {
                if (!isQuestableTopic(topicId)) return;
                const map = getQuestMap(QUEST_LEVELS.SUB);
                if (!map[topicId]) {
                    map[topicId] = QUEST_STATUS.NOT_ACCEPTED;
                }
            });
            QUEST_INDEX.topicIds.forEach((topicId) => {
                if (!isQuestableTopic(topicId)) return;
                const map = getQuestMap(QUEST_LEVELS.TOPIC);
                if (!map[topicId]) {
                    map[topicId] = QUEST_STATUS.NOT_ACCEPTED;
                }
            });
            contentLinks.forEach(link => applyQuestStatusToLink(link));
            saveQuestState();
        }

        function getLinkLabel(link) {
            const textNode = Array.from(link.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.nodeValue.trim());
            if (textNode) {
                return textNode.nodeValue.trim();
            }
            return link.textContent.trim();
        }

        function setModuleBannerText(title, subtitle) {
            if (!moduleTitleText) return;
            moduleTitleText.textContent = title || '';
            if (moduleSubtitle) {
                if (subtitle) {
                    moduleSubtitle.textContent = subtitle;
                    moduleSubtitle.hidden = false;
                } else {
                    moduleSubtitle.textContent = '';
                    moduleSubtitle.hidden = true;
                }
            }
        }

        function clearSheetBanner() {
            sheetBannerActive = false;
            if (moduleBanner) {
                moduleBanner.classList.remove('sheet-banner');
            }
            setModuleBannerText('', '');
        }

        function showSheetBanner(title, subtitle) {
            if (!moduleBanner || !moduleTitleText || !questAcceptBtn) return;
            setModuleBannerText(title, subtitle);
            moduleBanner.hidden = false;
            moduleBanner.classList.add('sheet-banner');
            questAcceptBtn.hidden = true;
            questAcceptBtn.disabled = true;
            sheetBannerActive = true;
        }

        function getSheetBannerFromSrc(src) {
            const normalized = src || '';
            if (SHEET_BANNER_MAP[normalized]) {
                return SHEET_BANNER_MAP[normalized];
            }
            const match = Object.keys(SHEET_BANNER_MAP).find((key) => normalized.endsWith(key));
            return match ? SHEET_BANNER_MAP[match] : null;
        }

        function syncSheetHeaderInBanner() {
            if (!iframe || currentTopicId) return;
            const src = iframe.getAttribute('src') || iframe.src || '';
            const banner = getSheetBannerFromSrc(src);
            if (banner) {
                showSheetBanner(banner.title, banner.subtitle);
                return;
            }
            if (sheetBannerActive && moduleBanner) {
                moduleBanner.hidden = true;
                clearSheetBanner();
            }
        }

        function updateModuleBanner(link) {
            if (!moduleBanner || !moduleTitleText || !questAcceptBtn) return;
            clearSheetBanner();
            if (!link) {
                moduleBanner.hidden = true;
                currentTopicId = null;
                return;
            }
            const topicId = link.getAttribute('data-topic-id');
            if (!isQuestableTopic(topicId)) {
                moduleBanner.hidden = true;
                currentTopicId = null;
                return;
            }
            currentTopicId = topicId;
            const sheetSubtitle = moduleSheetSubtitles[topicId] || '';
            setModuleBannerText(getLinkLabel(link), sheetSubtitle);
            moduleBanner.hidden = false;
            const status = getQuestStatus(topicId, getQuestType(topicId));
            questAcceptBtn.hidden = status !== QUEST_STATUS.NOT_ACCEPTED;
            questAcceptBtn.disabled = status !== QUEST_STATUS.NOT_ACCEPTED;
        }

        function lockModule(link) {
            if (!moduleLock || !iframe) return;
            lockedTopicId = link.getAttribute('data-topic-id');
            lockedModuleSrc = link.getAttribute('data-src');
            moduleLock.classList.remove('is-hidden');
            iframe.classList.add('is-hidden');
        }

        function unlockModule(loadLocked = false) {
            if (!moduleLock || !iframe) return;
            moduleLock.classList.add('is-hidden');
            iframe.classList.remove('is-hidden');
            if (loadLocked && lockedTopicId === currentTopicId && lockedModuleSrc) {
                iframe.src = lockedModuleSrc;
            }
            lockedTopicId = null;
            lockedModuleSrc = null;
        }

        function maybeUnlockContent(topicId) {
            if (!topicId) return;
            const status = getQuestStatus(topicId, getQuestType(topicId));
            if (status === QUEST_STATUS.NOT_ACCEPTED) return;
            if (currentTopicId === topicId) {
                unlockModule(true);
            }
        }

        function normalizeDifficultyKey(key) {
            if (!key) return '';
            const normalized = key.toString().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z]/g, '');
            if (normalized.startsWith('konny')) return 'konnyu';
            if (normalized.startsWith('kozep')) return 'normal';
            if (normalized.startsWith('normal')) return 'normal';
            if (normalized.startsWith('nehez')) return 'nehez';
            return normalized;
        }

        function getGradeValue(value) {
            if (typeof value === 'number') return value;
            if (value && typeof value.grade === 'number') return value.grade;
            return null;
        }

        function getTopicGradeSummary(topicData) {
            const normalized = {};
            let hasAnyGrade = false;
            Object.entries(topicData || {}).forEach(([difficulty, value]) => {
                const grade = getGradeValue(value);
                if (grade === null) return;
                if (grade > 0) {
                    hasAnyGrade = true;
                }
                const key = normalizeDifficultyKey(difficulty);
                if (!key) return;
                if (normalized[key] === undefined || grade > normalized[key]) {
                    normalized[key] = grade;
                }
            });
            return { normalized, hasAnyGrade };
        }

        function isTopicCompleted(topicId) {
            const topicData = progressData[topicId];
            if (!topicData) return false;
            const { normalized } = getTopicGradeSummary(topicData);
            const difficultyKeys = ['konnyu', 'normal', 'nehez'];
            const hasDifficultyGrades = difficultyKeys.some(key => normalized[key] !== undefined);
            if (hasDifficultyGrades) {
                return difficultyKeys.every(key => (normalized[key] || 0) >= 5);
            }
            return Object.values(normalized).some(grade => grade >= 5);
        }

        function hasAnyGrade(topicId) {
            const topicData = progressData[topicId];
            if (!topicData) return false;
            return getTopicGradeSummary(topicData).hasAnyGrade;
        }

        function computeTopicStatus(topicId) {
            const baseStatus = getQuestStatus(topicId, QUEST_LEVELS.TOPIC);
            let nextStatus = baseStatus;
            if (baseStatus === QUEST_STATUS.NOT_ACCEPTED && hasAnyGrade(topicId)) {
                nextStatus = QUEST_STATUS.ACTIVE;
            }
            if (isTopicCompleted(topicId)) {
                nextStatus = QUEST_STATUS.COMPLETED;
            }
            return nextStatus;
        }

        function computeSubtopicStatus(subtopicId, topicIds) {
            const baseStatus = getQuestStatus(subtopicId, QUEST_LEVELS.SUB);
            let nextStatus = baseStatus;
            const hasTest = hasAnyGrade(subtopicId);
            const hasActiveChild = (topicIds || []).some((topicId) => {
                const status = getQuestStatus(topicId, QUEST_LEVELS.TOPIC);
                return status === QUEST_STATUS.ACTIVE || status === QUEST_STATUS.COMPLETED;
            });
            if (baseStatus === QUEST_STATUS.NOT_ACCEPTED && (hasTest || hasActiveChild)) {
                nextStatus = QUEST_STATUS.ACTIVE;
            }
            const completedByGrade = isTopicCompleted(subtopicId);
            const allChildrenCompleted = (topicIds || []).length === 0
                ? true
                : topicIds.every((topicId) => getQuestStatus(topicId, QUEST_LEVELS.TOPIC) === QUEST_STATUS.COMPLETED);
            if (completedByGrade && allChildrenCompleted) {
                nextStatus = QUEST_STATUS.COMPLETED;
            }
            return nextStatus;
        }

        function computeMainTopicStatus(mainTopicId, subtopicIds) {
            const baseStatus = getQuestStatus(mainTopicId, QUEST_LEVELS.MAIN);
            let nextStatus = baseStatus;
            const hasTest = hasAnyGrade(mainTopicId);
            const hasActiveChild = (subtopicIds || []).some((subId) => {
                const status = getQuestStatus(subId, QUEST_LEVELS.SUB);
                return status === QUEST_STATUS.ACTIVE || status === QUEST_STATUS.COMPLETED;
            });
            if (baseStatus === QUEST_STATUS.NOT_ACCEPTED && (hasTest || hasActiveChild)) {
                nextStatus = QUEST_STATUS.ACTIVE;
            }
            const completedByGrade = isTopicCompleted(mainTopicId);
            const allSubtopicsCompleted = (subtopicIds || []).length === 0
                ? true
                : subtopicIds.every((subId) => getQuestStatus(subId, QUEST_LEVELS.SUB) === QUEST_STATUS.COMPLETED);
            if (completedByGrade && allSubtopicsCompleted) {
                nextStatus = QUEST_STATUS.COMPLETED;
            }
            return nextStatus;
        }

        function syncQuestHierarchyFromProgress() {
            if (!questState || typeof questState !== 'object') {
                questState = createQuestState();
            }
            QUEST_INDEX.topicIds.forEach((topicId) => {
                if (!isQuestableTopic(topicId)) return;
                const nextStatus = computeTopicStatus(topicId);
                setQuestStatus(topicId, nextStatus, { type: QUEST_LEVELS.TOPIC, persist: false });
            });
            Object.entries(QUEST_HIERARCHY.hierarchy.mainTopics || {}).forEach(([mainId, mainEntry]) => {
                const subtopics = mainEntry.subtopics || {};
                Object.entries(subtopics).forEach(([subId, subEntry]) => {
                    const topics = subEntry.topics || [];
                    const nextStatus = computeSubtopicStatus(subId, topics);
                    setQuestStatus(subId, nextStatus, { type: QUEST_LEVELS.SUB, persist: false });
                });
            });
            Object.entries(QUEST_HIERARCHY.hierarchy.mainTopics || {}).forEach(([mainId, mainEntry]) => {
                const subtopicIds = Object.keys(mainEntry.subtopics || {});
                const nextStatus = computeMainTopicStatus(mainId, subtopicIds);
                setQuestStatus(mainId, nextStatus, { type: QUEST_LEVELS.MAIN, persist: false });
            });
            saveQuestState();
        }

        function syncQuestStatusFromProgress(topicId) {
            if (!isQuestableTopic(topicId)) return;
            syncQuestHierarchyFromProgress();
        }

        function syncQuestStatusesFromProgress() {
            syncQuestHierarchyFromProgress();
        }

        function countQuestTopics(state) {
            if (!state || typeof state !== 'object') return 0;
            const mainCount = state.mainTopics ? Object.keys(state.mainTopics).length : 0;
            const subCount = state.subtopics ? Object.keys(state.subtopics).length : 0;
            const topicCount = state.topics ? Object.keys(state.topics).length : 0;
            return mainCount + subCount + topicCount;
        }

        function syncQuestStateFromSummary(summaryQuests) {
            if (!summaryQuests || typeof summaryQuests !== 'object') {
                ensureQuestDefaults();
                return;
            }
            const incoming = coerceQuestState(summaryQuests);
            const incomingCount = countQuestTopics(incoming);
            const localCount = countQuestTopics(questState);
            if (incomingCount > 0 || localCount === 0) {
                questState = mergeQuestState(questState, incoming);
                ensureQuestDefaults();
                maybeUnlockContent(currentTopicId);
                return;
            }
            ensureQuestDefaults();
        }

        ensureQuestDefaults();
        if (moduleBanner) {
            moduleBanner.hidden = true;
        }
        if (questAcceptBtn) {
            questAcceptBtn.hidden = true;
            questAcceptBtn.disabled = true;
        }
        if (moduleLock) {
            moduleLock.classList.add('is-hidden');
        }
        if (iframe) {
            iframe.classList.remove('is-hidden');
            iframe.addEventListener('load', () => {
                applySeededRandom(iframe.contentWindow);
                syncSheetHeaderInBanner();
                applySettingsToIframe(activeSettings || getDefaultSettings());
            });
        }

        function setQuestCollapsed(collapsed) {
            document.body.classList.toggle('quest-collapsed', collapsed);
            if (questToggle) {
                questToggle.setAttribute('aria-expanded', String(!collapsed));
            }
        }

        if (questToggle) {
            questToggle.addEventListener('click', () => {
                const nextCollapsed = !document.body.classList.contains('quest-collapsed');
                setQuestCollapsed(nextCollapsed);
            });
        }

        if (questBackdrop) {
            questBackdrop.addEventListener('click', () => {
                if (!document.body.classList.contains('quest-collapsed')) {
                    setQuestCollapsed(true);
                }
            });
        }

        if (settingsTabs && settingsTabs.length) {
            settingsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.dataset.section;
                    settingsTabs.forEach(btn => btn.classList.toggle('is-active', btn === tab));
                    settingsSections.forEach(section => {
                        section.classList.toggle('is-active', section.dataset.section === target);
                    });
                });
            });
        }

        if (themeCards && themeCards.length) {
            themeCards.forEach(card => {
                card.addEventListener('click', () => {
                    const themeId = card.dataset.theme;
                    if (!themeId) return;
                    if (themeId === 'custom') {
                        setThemeSelection('custom');
                        updateSettingsDraft({ themeId: 'custom' });
                        return;
                    }
                    const theme = THEME_TOKENS[themeId];
                    if (!theme) return;
                    const preservedImage = draftSettings ? draftSettings.contentBgImage : 'none';
                    const preservedAvatar = draftSettings ? draftSettings.avatarImage : '';
                    updateSettingsDraft({ ...theme, themeId, contentBgImage: preservedImage, avatarImage: preservedAvatar });
                    syncSettingsUI(draftSettings);
                });
            });
        }

        if (settingSidebarBg) {
            settingSidebarBg.addEventListener('input', (event) => {
                updateSettingsDraft({ sidebarBg: event.target.value, themeId: 'custom' });
                setThemeSelection('custom');
            });
        }
        if (settingContentBg) {
            settingContentBg.addEventListener('input', (event) => {
                updateSettingsDraft({ contentBg: event.target.value, themeId: 'custom' });
                setThemeSelection('custom');
            });
        }
        if (settingButtonBg) {
            settingButtonBg.addEventListener('input', (event) => {
                updateSettingsDraft({ buttonBg: event.target.value, themeId: 'custom' });
                setThemeSelection('custom');
            });
        }
        if (settingButtonText) {
            settingButtonText.addEventListener('input', (event) => {
                updateSettingsDraft({ buttonText: event.target.value, themeId: 'custom' });
                setThemeSelection('custom');
            });
        }
        if (settingLinkColor) {
            settingLinkColor.addEventListener('input', (event) => {
                updateSettingsDraft({ linkColor: event.target.value, themeId: 'custom' });
                setThemeSelection('custom');
            });
        }
        if (settingContentOverlay) {
            settingContentOverlay.addEventListener('input', (event) => {
                const value = event.target.value;
                updateSettingsDraft({ contentOverlay: value, themeId: 'custom' });
                setThemeSelection('custom');
                const overlayAlpha = getOverlayAlpha(value);
                if (settingContentOverlayAlpha) settingContentOverlayAlpha.value = String(overlayAlpha);
                if (settingContentOverlayAlphaValue) settingContentOverlayAlphaValue.textContent = overlayAlpha.toFixed(2);
            });
        }
        if (settingContentOverlayAlpha) {
            settingContentOverlayAlpha.addEventListener('input', (event) => {
                const rawValue = Number(event.target.value);
                const safeAlpha = clampOverlayAlpha(Number.isFinite(rawValue) ? rawValue : SETTINGS_MIN_OVERLAY_ALPHA);
                const baseSettings = draftSettings || activeSettings || getDefaultSettings();
                const baseOverlay = (settingContentOverlay && settingContentOverlay.value)
                    ? settingContentOverlay.value
                    : baseSettings.contentOverlay;
                const nextOverlay = applyOverlayAlpha(baseOverlay, safeAlpha);
                if (settingContentOverlay) {
                    settingContentOverlay.value = nextOverlay;
                }
                updateSettingsDraft({ contentOverlay: nextOverlay, themeId: 'custom' });
                setThemeSelection('custom');
                if (settingContentOverlayAlphaValue) {
                    settingContentOverlayAlphaValue.textContent = safeAlpha.toFixed(2);
                }
            });
        }
        if (settingModuleOpacity) {
            settingModuleOpacity.addEventListener('input', (event) => {
                const value = Number(event.target.value);
                updateSettingsDraft({ moduleCardOpacity: value, themeId: 'custom' });
                setThemeSelection('custom');
                if (settingModuleOpacityValue) {
                    settingModuleOpacityValue.textContent = Number.isFinite(value) ? value.toFixed(2) : '1.00';
                }
            });
        }
        if (settingFontScale) {
            settingFontScale.addEventListener('change', (event) => {
                const value = Number(event.target.value || 100);
                updateSettingsDraft({ fontScale: Number.isNaN(value) ? 100 : value });
            });
        }
        if (settingReduceMotion) {
            settingReduceMotion.addEventListener('change', (event) => {
                updateSettingsDraft({ reduceMotion: Boolean(event.target.checked) });
            });
        }
        if (settingBgFile) {
            settingBgFile.addEventListener('change', (event) => {
                const file = event.target.files && event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (loadEvent) => {
                    const result = loadEvent.target && loadEvent.target.result;
                    if (typeof result !== 'string') return;
                    updateSettingsDraft({ contentBgImage: `url(${result})`, themeId: 'custom' });
                    setThemeSelection('custom');
                    syncSettingsUI(draftSettings);
                };
                reader.readAsDataURL(file);
            });
        }
        if (settingAvatarFile) {
            settingAvatarFile.addEventListener('change', (event) => {
                const file = event.target.files && event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (loadEvent) => {
                    const result = loadEvent.target && loadEvent.target.result;
                    if (typeof result !== 'string') return;
                    updateSettingsDraft({ avatarImage: `url(${result})`, themeId: 'custom' });
                    setThemeSelection('custom');
                    syncSettingsUI(draftSettings);
                };
                reader.readAsDataURL(file);
            });
        }
        if (settingsFab) {
            settingsFab.addEventListener('click', () => {
                openSettingsOverlay();
            });
        }
        if (settingsClose) {
            settingsClose.addEventListener('click', () => {
                closeSettingsOverlay(true);
            });
        }
        if (settingsCancel) {
            settingsCancel.addEventListener('click', () => {
                closeSettingsOverlay(true);
            });
        }
        if (settingsSave) {
            settingsSave.addEventListener('click', async () => {
                if (!draftSettings) return;
                const normalized = normalizeSettings(draftSettings);
                setActiveSettings(normalized);
                if (window.electronAPI) {
                    try {
                        await window.electronAPI.saveSettings(normalized);
                    } catch (error) {
                        console.error('Nem sikerült a beállítások mentése:', error);
                    }
                }
                closeSettingsOverlay(false);
            });
        }
        if (settingsOverlay) {
            settingsOverlay.addEventListener('click', (event) => {
                if (event.target === settingsOverlay) {
                    closeSettingsOverlay(true);
                }
            });
        }
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && settingsOverlay && !settingsOverlay.classList.contains('is-hidden')) {
                event.preventDefault();
                closeSettingsOverlay(true);
            }
        });

        if (playerAvatar) {
            playerAvatar.addEventListener('click', () => {
                openCharacterSheet();
            });
        }
        if (xpLevelLabel) {
            xpLevelLabel.addEventListener('click', () => {
                openCharacterSheet();
            });
        }

        if (questAcceptBtn) {
            questAcceptBtn.addEventListener('click', () => {
                if (!currentTopicId) return;
                setQuestStatus(currentTopicId, QUEST_STATUS.ACTIVE);
                syncQuestHierarchyFromProgress();
            });
        }

        resultsBtn.addEventListener('click', (event) => {
            event.preventDefault();
            setActiveLink(resultsBtn);
            iframe.src = 'modules/results.html';
            updateModuleBanner(null);
            unlockModule();
        });

        contentLinks.forEach(link => {
            link.addEventListener('click', (event) => {
                event.preventDefault();
                if (link.classList.contains('main-topic')) { event.stopPropagation(); }
                const topicId = link.getAttribute('data-topic-id');
                if (topicId === 'settings') {
                    openSettingsOverlay();
                    return;
                }
                setActiveLink(link);
                updateModuleBanner(link);
                if (isQuestableTopic(topicId) && getQuestStatus(topicId, getQuestType(topicId)) === QUEST_STATUS.NOT_ACCEPTED) {
                    lockModule(link);
                    return;
                }
                unlockModule();
                iframe.src = link.getAttribute('data-src');
            });
        });

        window.addEventListener('message', async (event) => {
            const data = event.data;
            if (data.type === 'testResult') {
                const result = data.result || (data.topicId ? { ...data } : null);
                if (!result) return;
                if (result.type) delete result.type;
                if (window.electronAPI) { window.electronAPI.saveTestResult(result); }
                const topicId = result.topicId;
                const difficultyKey = result.difficulty || 'teszt';
                const gradeValue = Number(result.grade);
                if (topicId && !Number.isNaN(gradeValue)) {
                    if (!progressData[topicId]) { progressData[topicId] = {}; }
                    progressData[topicId][difficultyKey] = gradeValue;
                    updateCircleColor(topicId);
                    syncQuestStatusFromProgress(topicId);
                }
                refreshProgressSummary();
            }
            else if (data.type === 'get-all-results') {
                if (window.electronAPI) {
                    const results = await window.electronAPI.getAllResults();
                    iframe.contentWindow.postMessage({ type: 'all-results-response', results: results }, '*');
                }
            } else if (data.type === 'request-xp-summary') {
                if (window.electronAPI) {
                    const summary = await window.electronAPI.getProgressSummary();
                    iframe.contentWindow.postMessage({ type: 'xp-summary', summary }, '*');
                }
            } else if (data.type === 'save-settings' && data.settings) {
                if (window.electronAPI) {
                    try {
                        await window.electronAPI.saveSettings(data.settings);
                    } catch (error) {
                        console.error('Nem sikerült a beállítások mentése:', error);
                    }
                }
                setActiveSettings(data.settings);
            } else if (data.type === 'practiceXp') {
                if (window.electronAPI) {
                    const xp = Number(data.xp);
                    if (!Number.isNaN(xp) && xp > 0) {
                        try {
                            await window.electronAPI.savePracticeXp({ topicId: data.topicId, xp });
                            await refreshProgressSummary();
                        } catch (error) {
                            console.error('Nem sikerült a practice XP mentése:', error);
                        }
                    }
                }
            } else if (data.type === 'module-sheet') {
                const topicId = typeof data.topicId === 'string' ? data.topicId : '';
                const subtitle = typeof data.subtitle === 'string' ? data.subtitle.trim() : '';
                if (!topicId || !isQuestableTopic(topicId)) return;
                moduleSheetSubtitles[topicId] = subtitle;
                if (currentTopicId === topicId && !sheetBannerActive) {
                    const link = document.querySelector(`[data-topic-id="${topicId}"]`);
                    if (link) {
                        setModuleBannerText(getLinkLabel(link), subtitle);
                        if (moduleBanner) {
                            moduleBanner.hidden = false;
                        }
                    }
                }
            } else if (data.type === 'apply-settings' && data.settings) {
                setActiveSettings(data.settings);
            } else if (data.type === 'request-settings') {
                const settings = activeSettings || (window.electronAPI ? await window.electronAPI.getSettings() : null);
                if (settings && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ type: 'apply-settings', settings }, '*');
                }
            }
        });

        async function refreshProgressSummary() {
            if (!window.electronAPI) return;
            try {
                const summary = await window.electronAPI.getProgressSummary();
                if (!summary) return;
                updateXpWidget(summary);
                syncQuestStateFromSummary(summary.quests);
                if (summary.completions) {
                    hydrateProgressData(summary.completions);
                }
            } catch (error) {
                console.error('Nem siker&#252;lt bet&#246;lteni az XP &#246;sszegz&#233;st:', error);
            }
        }

        function updateXpWidget(summary) {
            if (!summary || !summary.level) return;
            const totalXp = summary.xp || 0;
            xpLevelLabel.textContent = `Lv. ${formatNumber(summary.level.level, '1')}`;
            if (xpLevelName) {
                const name = summary.level.levelName || '';
                xpLevelName.textContent = name ? `- ${name}` : '';
            }
            xpTotalLabel.textContent = `${formatNumber(totalXp, '0')} XP`;
            const current = Number.isFinite(summary.level.xpIntoLevel) ? summary.level.xpIntoLevel : 0;
            const required = Number.isFinite(summary.level.xpForNext) ? summary.level.xpForNext : 0;
            const isMaxLevel = required <= 0;
            const safeRequired = isMaxLevel ? Math.max(1, current) : required;
            const percentage = Math.min(100, Math.round((current / safeRequired) * 100));
            xpBarFill.style.width = `${percentage}%`;
            xpProgressText.textContent = isMaxLevel
                ? `Max szint`
                : `${formatNumber(current, '0')} / ${formatNumber(required, '0')} XP a kovetkezo szintig`;
            if (xpBar) {
                xpBar.setAttribute('title', isMaxLevel ? 'Max szint' : `${formatNumber(current, '0')} / ${formatNumber(required, '0')} XP`);
            }
        }

        function formatDifficultyTooltip(normalized, key, label) {
            const grade = normalized[key];
            if (!grade) return `${label}: N/A`;
            return `${label}: Jegy: ${grade}`;
        }
        function hydrateProgressData(completions) {
            progressData = {};
            Object.entries(completions || {}).forEach(([topicId, difficulties]) => {
                if (!progressData[topicId]) { progressData[topicId] = {}; }
                Object.entries(difficulties || {}).forEach(([difficultyLabel, data]) => {
                    const gradeValue = typeof data === 'number' ? data : data.grade;
                    progressData[topicId][difficultyLabel] = gradeValue;
                });
                updateCircleColor(topicId);
            });
            syncQuestStatusesFromProgress();
        }

        function updateCircleColor(topicId) {
            const statusCircle = document.querySelector(`.status[data-grade-for="${topicId}"]`);
            if (statusCircle && progressData[topicId]) {
                const grades = Object.values(progressData[topicId])
                    .map(value => typeof value === 'number' ? value : (value ? value.grade : null))
                    .filter(g => g !== null && g > 0);
                const bestGrade = grades.length > 0 ? Math.max(...grades) : 0;
                statusCircle.className = 'status'; 
                statusCircle.classList.add(`grade-${bestGrade}`);
            }
        }

        document.querySelectorAll('.status').forEach(circle => {
            circle.addEventListener('mouseover', (event) => {
                const topicId = circle.dataset.gradeFor;
                const topicData = progressData[topicId];
                let tooltipContent = "M&#233;g nincsenek eredm&#233;nyek.";
                if (topicData) {
                    const summary = getTopicGradeSummary(topicData);
                    tooltipContent = `<b>Eredm&#233;nyek (${topicId}):</b><br>
                        ${formatDifficultyTooltip(summary.normalized, 'konnyu', 'K&#246;nny&#369;')}<br>
                        ${formatDifficultyTooltip(summary.normalized, 'normal', 'Norm&#225;l')}<br>
                        ${formatDifficultyTooltip(summary.normalized, 'nehez', 'Neh&#233;z')}`;
                }
                tooltip.innerHTML = tooltipContent;
                tooltip.style.display = 'block';
            });
            circle.addEventListener('mousemove', (event) => { tooltip.style.left = (event.pageX + 15) + 'px'; tooltip.style.top = (event.pageY + 15) + 'px'; });
            circle.addEventListener('mouseout', () => { tooltip.style.display = 'none'; });
        });

        refreshProgressSummary();

        // Load and apply settings on page load
        async function loadAndApplySettings() {
            if (window.electronAPI) {
                try {
                    const settings = await window.electronAPI.getSettings();
                    if (settings) {
                        setActiveSettings(settings);
                        return;
                    }
                } catch (error) {
                    console.error('Nem sikerült a beállítások betöltése:', error);
                }
            }
            setActiveSettings(getDefaultSettings());
        }

        window.addEventListener('DOMContentLoaded', loadAndApplySettings);

    document.addEventListener('DOMContentLoaded', () => {
  const topicNames = {
    alapozo_modulzaro: 'Alapozó Modulok',
    gondolkodas_temazaro: 'Gondolkodási módszerek, Halmazok',
    halmazmuveletek: 'Halmazműveletek',
    logikai_szita: 'Logikai szita formula',
    skatulya_elv: 'Skatulya-elv, párosítások',
    szamelmelet_temazaro: 'Számelmélet és Számrendszerek',
    oszthatosag: 'Oszthatósági szabályok',
    lnko_lkkt: 'LNKO, LKKT',
    primtenyezok: 'Prímtényezős felbontás',
    szamrendszerek: 'Számrendszerek',
    racionalis_szamok_temazaro: 'Racionális számok',
    tortek: 'Törtek és műveletek',
    tizedes_tortek: 'Tizedes törtek, átváltások',
    szazalekszamitas: 'Százalékszámítás',
    hatvany_temazaro: 'Hatvány, Gyök, Logaritmus',
    hatvanyozas: 'Hatványozás azonosságai',
    gyokvonas: 'Négyzetgyök, n-edik gyök',
    logaritmus: 'A logaritmus fogalma',
    algebra_modulzaro: 'Algebra és Függvények',
    algebrai_kif_temazaro: 'Algebrai kifejezések',
    polinomok: 'Műveletek polinomokkal',
    nevezetes_azonossagok: 'Nevezetes azonosságok',
    algebrai_tortek: 'Algebrai törtek',
    egyenletek_temazaro: 'Egyenletek, Egyenlőtlenségek',
    linearis_egyenletek: 'Lineáris egyenletek',
    masodfoku_egyenlet: 'Másodfokú egyenlet',
    viete_formulak: 'Viète-formulák',
    parameteres_masodfoku: 'Paraméteres másodfokú egyenletek',
    specialis_egyenletek: 'Abszolútértékes, gyökös stb.',
    fuggvenyek_alt_temazaro: 'Függvények általános tulajdonságai',
    fuggveny_alapok: 'Értelmezési tartomány, értékkészlet',
    fuggveny_jellemzes: 'Monotonitás, szélsőértékek',
    paritas: 'Paritás (páros, páratlan)',
    fuggveny_transzformaciok: 'Függvénytranszformációk',
    nevezetes_fuggvenyek_temazaro: 'Nevezetes függvények',
    linearis_fuggveny: 'Lineáris függvény',
    masodfoku_fuggveny: 'Másodfokú függvény',
    hatvanyfuggvenyek: 'Hatványfüggvények',
    exp_log_fuggveny: 'Exponenciális és logaritmus fv.',
    trigonometrikus_fuggvenyek: 'Trigonometrikus fv.',
    specialis_fuggvenyek: 'Abszolútérték, gyök fv.',
    geometria_modulzaro: 'Geometria',
    haromszogek_temazaro: 'Alapfogalmak és Háromszögek',
    nevezetes_vonalak: 'Nevezetes vonalak',
    haromszog_egyenlotlenseg: 'Háromszög-egyenlőtlenség',
    szogtetelek: 'Pitagorasz, befogó, magasság',
    szinusz_koszinusz_tetel: 'Szinusztétel, Koszinusztétel',
    sokszogek_temazaro: 'Négyzetek és Sokszögek',
    terulet_kerulet: 'Terület- és kerületszámítás',
    specialis_negyszogek: 'Húrnégyszögek, érintőnégyszögek',
    kor_temazaro: 'A Kör',
    keruleti_szogek: 'Kerületi és középponti szögek',
    latokoriv: 'Látókörív',
    kor_helyzetek: 'Kör és egyenes, kör és kör',
    geo_transzform_temazaro: 'Geometriai Transzformációk',
    tukrozes: 'Tengelyes és középpontos tükrözés',
    eltolas_forgatas: 'Eltolás, elforgatás',
    hasonlosag: 'Középpontos hasonlóság',
    koordinatageometria_temazaro: 'Koordinátageometria',
    vektorok: 'Vektorok (skaláris szorzat)',
    egyenes_egyenlete: 'Pont, szakasz, egyenes',
    kor_egyenlete: 'Kör egyenlete',
    alakzatok_metszespontja: 'Két alakzat metszéspontja',
    tergeometria_temazaro: 'Térgeometria',
    hasabok_gulak: 'Hasábok, gúlák F, V',
    forgastestek: 'Forgástestek (henger, kúp, gömb)',
    valstat_modulzaro: 'Valószínűségszámítás és Statisztika',
    kombinatorika_temazaro: 'Kombinatorika',
    permutaciok: 'Permutációk',
    variaciok: 'Variációk',
    kombinaciok: 'Kombinációk',
    binomialis_tetel: 'Binomiális tétel',
    valszam_temazaro: 'Valószínűségszámítás',
    klasszikus_valoszinuseg: 'Klasszikus valószínűségi modell',
    geometriai_valoszinuseg: 'Geometriai valószínűség',
    felteteles_valoszinuseg: 'Feltételes valószínűség',
    statisztika_temazaro: 'Statisztika',
    adatok_abrazolasa: 'Adatok ábrázolása',
    kozepertekek: 'Középértékek',
    szorodas: 'Szóródási mutatók',
    emelt_modulzaro: 'Emelt Szintű Kiegészítések',
    sorozatok_temazaro: 'Sorozatok',
    szamtani_mertani: 'Számtani és mértani sorozatok',
    kamatoskamat: 'Kamatoskamat-számítás',
    konvergencia: 'Konvergencia',
    differencial_temazaro: 'Differenciálszámítás',
    hatarertek: 'Határértékek, folytonosság',
    derivalt_fogalma: 'A derivált fogalma',
    derivalsi_szabalyok: 'Deriválási szabályok',
    fuggvenyvizsgalat: 'Függvényvizsgálat deriválttal',
    integral_temazaro: 'Integrálszámítás',
    hatarozatlan_integral: 'A határozatlan integrál',
    hatarozott_integral: 'A határozott integrál',
    newton_leibniz: 'Newton-Leibniz formula',
    terfogatszamitas: 'Térfogatszámítás integrállal'
  };
  document.querySelectorAll('.module-link').forEach(link => {
    const id = link.getAttribute('data-topic-id');
    if (id && topicNames[id]) {
      const textNodes = Array.from(link.childNodes).filter(n => n.nodeType === Node.TEXT_NODE);
      if (textNodes.length > 0) {
        textNodes[0].nodeValue = topicNames[id];
      } else {
        const span = link.querySelector('span');
        if (span) {
          span.remove();
          link.textContent = topicNames[id];
          link.appendChild(span);
        } else {
          link.textContent = topicNames[id];
        }
      }
    }
  });
  if (contentLinks && contentLinks.length) {
    contentLinks.forEach(link => applyQuestStatusToLink(link));
  }
});
    </script>
</body>
</html>

]
