<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Achievementek</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --accent: #5865f2;
            --surface: #f5f7fb;
            --panel: rgba(255, 255, 255, var(--module-card-opacity, 0.92));
            --panel-strong: rgba(255, 255, 255, var(--module-card-opacity, 1));
            --text: #1f2933;
            --muted: #6b7280;
            --border: rgba(15, 23, 42, 0.1);
            --overlay: rgba(255, 255, 255, 0.8);
            --success: #2ecc71;
            --warning: #f39c12;
        }

        * { box-sizing: border-box; }
        html, body { background-color: transparent; }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            padding: 32px;
            min-height: 100vh;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--overlay);
            pointer-events: none;
            z-index: 0;
        }

        .achievement-shell {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 24px;
        }

        .achievement-header {
            display: grid;
            gap: 16px;
        }

        .achievement-header h1 {
            margin: 0;
            font-size: 2rem;
        }
        .achievement-header p {
            margin: 6px 0 0;
            color: var(--muted);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .summary-card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            display: grid;
            gap: 8px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, 0.14);
        }

        .summary-label {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-meta {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .summary-bar {
            height: 10px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 999px;
            overflow: hidden;
        }

        .summary-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), #9f7bff);
            transition: width 0.3s ease;
        }

        .section-title {
            margin: 8px 0 4px;
            font-size: 1rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }

        .achievement-grid {
            display: grid;
            gap: 12px;
        }

        .achievement-card {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 14px 16px;
            display: grid;
            grid-template-columns: 48px 1fr auto;
            gap: 12px;
            align-items: start;
        }

        .achievement-card.is-locked {
            opacity: 0.65;
            border-style: dashed;
        }

        .achievement-badge {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: rgba(88, 101, 242, 0.15);
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--accent);
        }

        .achievement-card.is-unlocked .achievement-badge {
            background: rgba(46, 204, 113, 0.2);
            border-color: rgba(46, 204, 113, 0.45);
            color: var(--success);
        }

        .achievement-content {
            display: grid;
            gap: 6px;
            min-width: 0;
        }

        .achievement-title-row {
            display: flex;
            align-items: baseline;
            gap: 8px;
            flex-wrap: wrap;
        }

        .achievement-title {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 600;
            overflow-wrap: anywhere;
        }

        .achievement-category {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(88, 101, 242, 0.14);
            color: var(--accent);
        }

        .achievement-desc {
            margin: 0;
            color: var(--muted);
            font-size: 0.9rem;
            overflow-wrap: anywhere;
        }

        .achievement-meta {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .achievement-reward {
            text-align: right;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            min-width: 0;
        }

        .achievement-reward small {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--muted);
        }

        .achievement-card.is-locked .achievement-reward {
            color: var(--muted);
        }

        .empty-state {
            padding: 16px;
            border-radius: 12px;
            border: 1px dashed var(--border);
            color: var(--muted);
            background: rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 900px) {
            .achievement-card {
                grid-template-columns: 48px 1fr;
                align-items: start;
            }
            .achievement-reward {
                text-align: left;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 20px;
            }
        }

        /* Touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
            font: inherit;
            color: inherit;
        }
    </style>
</head>
<body>
    <div class="achievement-shell">
        <header class="achievement-header">
            <div>
                <h1>Achievementek</h1>
                <p>Gy&#369;jts jelv&#233;nyeket extra c&#233;lok&#233;rt &#233;s k&#252;l&#246;nleges kih&#237;v&#225;sok&#233;rt.</p>
            </div>
            <div class="summary-grid">
                <div class="summary-card">
                    <span class="summary-label">Megszerezve</span>
                    <div class="summary-value" id="summary-unlocked">0 / 0</div>
                    <div class="summary-bar">
                        <div class="summary-bar-fill" id="summary-progress"></div>
                    </div>
                    <span class="summary-meta" id="summary-progress-text">0%</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">B&#243;nusz XP</span>
                    <div class="summary-value" id="summary-xp">0 XP</div>
                    <span class="summary-meta">Achievement jutalmakb&#243;l</span>
                </div>
                <div class="summary-card">
                    <span class="summary-label">K&#246;vetkez&#337; c&#233;l</span>
                    <div class="summary-value" id="summary-next">-</div>
                    <span class="summary-meta" id="summary-next-desc"></span>
                </div>
            </div>
        </header>

        <section>
            <div class="section-title">Megszerezve</div>
            <div class="achievement-grid" id="achievement-unlocked"></div>
            <div class="empty-state" id="achievement-unlocked-empty" style="display:none;">M&#233;g nincsenek achievementek.</div>
        </section>

        <section>
            <div class="section-title">El&#233;rhet&#337;</div>
            <div class="achievement-grid" id="achievement-locked"></div>
            <div class="empty-state" id="achievement-locked-empty" style="display:none;">Minden achievement megvan.</div>
        </section>
    </div>

    <script>
        const dom = {
            summaryUnlocked: document.getElementById('summary-unlocked'),
            summaryProgress: document.getElementById('summary-progress'),
            summaryProgressText: document.getElementById('summary-progress-text'),
            summaryXp: document.getElementById('summary-xp'),
            summaryNext: document.getElementById('summary-next'),
            summaryNextDesc: document.getElementById('summary-next-desc'),
            unlockedList: document.getElementById('achievement-unlocked'),
            unlockedEmpty: document.getElementById('achievement-unlocked-empty'),
            lockedList: document.getElementById('achievement-locked'),
            lockedEmpty: document.getElementById('achievement-locked-empty'),
        };

        const ACHIEVEMENT_FALLBACK = [
            {
                id: 'first_test',
                title: 'Els\u0151 teszteredm\u00e9ny',
                description: 'Els\u0151 sikeres teszt (jegy \u2265 2).',
                xpReward: 0,
                category: 'performance',
            },
            {
                id: 'hard_first',
                title: 'Neh\u00e9z harcos',
                description: 'Els\u0151 neh\u00e9z teszt sikeresen teljes\u00edtve.',
                xpReward: 50,
                category: 'difficulty',
            },
            {
                id: 'hard_perfect',
                title: 'T\u00f6k\u00e9letes vizsga',
                description: '5-\u00f6s jegy neh\u00e9z teszten.',
                xpReward: 75,
                category: 'performance',
            },
            {
                id: 'streak_5',
                title: 'Sorozatgy\u0151ztes',
                description: '5 egym\u00e1s ut\u00e1ni j\u00f3 eredm\u00e9ny.',
                xpReward: 50,
                category: 'performance',
            },
            {
                id: 'subtopic_master',
                title: 'Alt\u00e9ma z\u00e1r\u00f3',
                description: 'Egy alt\u00e9ma kimaxol\u00e1sa.',
                xpReward: 80,
                category: 'structure',
            },
            {
                id: 'main_topic_master',
                title: 'F\u0151t\u00e9ma mester',
                description: 'Egy f\u0151t\u00e9ma kimaxol\u00e1sa.',
                xpReward: 120,
                category: 'structure',
            },
            {
                id: 'emelt_bajnok',
                title: 'Emelt bajnok',
                description: 'Emelt modulz\u00e1r\u00f3 sikeres teljes\u00edt\u00e9se.',
                xpReward: 150,
                category: 'difficulty',
            },
            {
                id: 'xp_collector_1000',
                title: 'XP gy\u0171jt\u0151',
                description: '\u00d6sszegy\u0171jt\u00f6tt\u00e9l 1000 XP-t.',
                xpReward: 100,
                category: 'special',
            },
            {
                id: 'level_up',
                title: 'Szintl\u00e9p\u0151',
                description: 'El\u00e9rt\u00e9l egy \u00faj szintet.',
                xpReward: 0,
                category: 'special',
            },
        ];

        const CATEGORY_LABELS = {
            performance: 'Teljes\u00edtm\u00e9ny',
            difficulty: 'Neh\u00e9zs\u00e9gi szint',
            structure: 'Strukt\u00fara',
            special: 'Speci\u00e1lis',
        };
        const CATEGORY_BADGES = {
            performance: 'T',
            difficulty: 'N',
            structure: 'ST',
            special: 'SP',
        };

        const LOCALE = 'hu-HU';
        const numberFormatter = new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 0 });

        function formatNumber(value, fallback = '-') {
            if (value === null || value === undefined || value === '') return fallback;
            const num = Number(value);
            return Number.isFinite(num) ? numberFormatter.format(num) : fallback;
        }

        function formatDate(value) {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString(LOCALE);
        }

        function parseHexColor(hex) {
            const match = (hex || '').trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (!match) return null;
            const raw = match[1];
            const full = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
            return {
                r: parseInt(full.slice(0, 2), 16),
                g: parseInt(full.slice(2, 4), 16),
                b: parseInt(full.slice(4, 6), 16),
            };
        }

        function isDarkColor(hex) {
            const rgb = parseHexColor(hex);
            if (!rgb) return false;
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            return luminance < 0.5;
        }

        function normalizeOverlayColor(value) {
            const minAlpha = 0.35;
            const fallback = `rgba(15, 18, 22, ${minAlpha})`;
            if (!value || typeof value !== 'string') return fallback;
            const trimmed = value.trim();
            const rgbaMatch = trimmed.match(/^rgba?\(([^)]+)\)$/i);
            if (rgbaMatch) {
                const parts = rgbaMatch[1].split(',').map(part => part.trim());
                const r = Number(parts[0]);
                const g = Number(parts[1]);
                const b = Number(parts[2]);
                if ([r, g, b].some(Number.isNaN)) return fallback;
                const alpha = parts.length > 3 ? Number(parts[3]) : minAlpha;
                const safeAlpha = Math.min(0.9, Math.max(minAlpha, Number.isNaN(alpha) ? minAlpha : alpha));
                return `rgba(${r}, ${g}, ${b}, ${safeAlpha})`;
            }
            const hexMatch = trimmed.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hexMatch) {
                const rgb = parseHexColor(trimmed);
                if (!rgb) return fallback;
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${minAlpha})`;
            }
            return fallback;
        }

        function applySettings(settings) {
            if (!settings) return;
            const contentBg = settings.contentBg || '#f5f7fb';
            const isDark = isDarkColor(contentBg);
            const rawOpacity = Number(settings.moduleCardOpacity);
            const panelAlpha = Number.isFinite(rawOpacity) ? Math.min(1, Math.max(0.5, rawOpacity)) : 0.92;
            const panelStrongAlpha = Math.min(1, panelAlpha + 0.08);
            const panelRgb = isDark ? '20, 24, 30' : '255, 255, 255';
            document.documentElement.style.setProperty('--accent', settings.buttonBg || '#5865f2');
            document.documentElement.style.setProperty('--overlay', normalizeOverlayColor(settings.contentOverlay));
            document.documentElement.style.setProperty('--panel', `rgba(${panelRgb}, ${panelAlpha})`);
            document.documentElement.style.setProperty('--panel-strong', `rgba(${panelRgb}, ${panelStrongAlpha})`);
            document.documentElement.style.setProperty('--text', isDark ? '#f3f4f6' : '#1f2933');
            document.documentElement.style.setProperty('--muted', isDark ? '#cbd5f5' : '#6b7280');
            document.documentElement.style.setProperty('--border', isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(15, 23, 42, 0.1)');
            document.body.style.backgroundColor = 'transparent';
            document.body.style.backgroundImage = 'none';
        }

        function getCatalog(summary) {
            if (summary && Array.isArray(summary.achievementCatalog)) return summary.achievementCatalog;
            return ACHIEVEMENT_FALLBACK;
        }

        function getStates(summary) {
            return summary && summary.achievements ? summary.achievements : {};
        }

        function buildAchievementCard(achievement, state, isUnlocked) {
            const card = document.createElement('div');
            card.className = `achievement-card ${isUnlocked ? 'is-unlocked' : 'is-locked'}`;
            card.dataset.achievementId = achievement.id;
            const category = achievement.category || 'special';
            const categoryLabel = CATEGORY_LABELS[category] || 'Speci\u00e1lis';
            const badgeText = CATEGORY_BADGES[category] || 'SP';
            const rewardValue = Number(isUnlocked && Number.isFinite(state && state.grantedXp)
                ? state.grantedXp
                : (achievement.xpReward || 0));
            const rewardText = rewardValue > 0
                ? `+${formatNumber(rewardValue, '0')} XP`
                : 'Jelv\u00e9ny';
            let metaText = isUnlocked ? 'Megszerezve' : 'M\u00e9g nem szerzett';
            if (state && state.unlockedAt) {
                const dateLabel = formatDate(state.unlockedAt);
                if (dateLabel) {
                    metaText = `Megszerezve: ${dateLabel}`;
                }
            }
            card.innerHTML = `
                <div class="achievement-badge" aria-hidden="true">${badgeText}</div>
                <div class="achievement-content">
                    <div class="achievement-title-row">
                        <h3 class="achievement-title">${achievement.title || achievement.id}</h3>
                        <span class="achievement-category">${categoryLabel}</span>
                    </div>
                    <p class="achievement-desc">${achievement.description || ''}</p>
                    <span class="achievement-meta">${metaText}</span>
                </div>
                <div class="achievement-reward">
                    <small>Jutalom</small>
                    ${rewardText}
                </div>
            `;
            return card;
        }

        function renderSummary(catalog, states) {
            const unlocked = catalog.filter(item => states[item.id]?.isUnlocked);
            const total = catalog.length;
            const unlockedCount = unlocked.length;
            const percent = total ? Math.round((unlockedCount / total) * 100) : 0;
            if (dom.summaryUnlocked) {
                dom.summaryUnlocked.textContent = `${formatNumber(unlockedCount, '0')} / ${formatNumber(total, '0')}`;
            }
            if (dom.summaryProgress) {
                dom.summaryProgress.style.width = `${percent}%`;
            }
            if (dom.summaryProgressText) {
                dom.summaryProgressText.textContent = `${formatNumber(percent, '0')}%`;
            }
            const bonusXp = unlocked.reduce((sum, item) => {
                const granted = states[item.id] && Number.isFinite(states[item.id].grantedXp)
                    ? states[item.id].grantedXp
                    : item.xpReward;
                return sum + Number(granted || 0);
            }, 0);
            if (dom.summaryXp) {
                dom.summaryXp.textContent = `${formatNumber(bonusXp, '0')} XP`;
            }
            const next = catalog.find(item => !states[item.id]?.isUnlocked);
            if (dom.summaryNext) {
                dom.summaryNext.textContent = next ? (next.title || next.id) : 'Minden achievement megvan';
            }
            if (dom.summaryNextDesc) {
                dom.summaryNextDesc.textContent = next ? (next.description || '') : '';
            }
        }

        function renderAchievementLists(catalog, states) {
            const unlocked = [];
            const locked = [];
            catalog.forEach((achievement) => {
                const state = states[achievement.id] || {};
                const isUnlocked = Boolean(state.isUnlocked);
                const card = buildAchievementCard(achievement, state, isUnlocked);
                if (isUnlocked) {
                    unlocked.push(card);
                } else {
                    locked.push(card);
                }
            });
            if (dom.unlockedList) {
                dom.unlockedList.innerHTML = '';
                if (unlocked.length) {
                    dom.unlockedEmpty.style.display = 'none';
                    unlocked.forEach(card => dom.unlockedList.appendChild(card));
                } else {
                    dom.unlockedEmpty.style.display = 'block';
                }
            }
            if (dom.lockedList) {
                dom.lockedList.innerHTML = '';
                if (locked.length) {
                    dom.lockedEmpty.style.display = 'none';
                    locked.forEach(card => dom.lockedList.appendChild(card));
                } else {
                    dom.lockedEmpty.style.display = 'block';
                }
            }
        }

        function renderAchievements(summary) {
            const catalog = getCatalog(summary);
            const states = getStates(summary);
            renderSummary(catalog, states);
            renderAchievementLists(catalog, states);
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.parent.postMessage({ type: 'request-xp-summary' }, '*');
            window.parent.postMessage({ type: 'request-settings' }, '*');
        });

        window.addEventListener('message', (event) => {
            if (event.data.type === 'xp-summary') {
                renderAchievements(event.data.summary || {});
            }
            if (event.data.type === 'apply-settings') {
                applySettings(event.data.settings);
            }
        });
    </script>
</body>
</html>
