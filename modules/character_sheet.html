<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Karakterlap</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --accent: #5865f2;
            --surface: #f5f7fb;
            --panel: rgba(255, 255, 255, var(--module-card-opacity, 0.92));
            --panel-strong: rgba(255, 255, 255, var(--module-card-opacity, 1));
            --text: #1f2933;
            --muted: #6b7280;
            --border: rgba(15, 23, 42, 0.1);
            --overlay: rgba(255, 255, 255, 0.8);
            --success: #2ecc71;
            --warning: #f39c12;
            --avatar-image: radial-gradient(circle at 30% 30%, #8b93a7, #2e3642);
        }

        * { box-sizing: border-box; }
        html, body { background-color: transparent; height: 100%; }
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            padding: 32px;
            min-height: 0;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--overlay);
            pointer-events: none;
            z-index: 0;
        }

        .sheet {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: minmax(280px, 1.1fr) minmax(320px, 0.9fr);
            grid-template-rows: minmax(0, 1fr);
            gap: 24px;
            flex: 1;
            min-height: 0;
        }
        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 45px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }
        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
            flex-shrink: 0;
        }
        .tab-button {
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: border-color 0.2s ease, transform 0.2s ease;
        }
        .tab-button.is-active {
            border-color: var(--accent);
            transform: translateY(-1px);
            background: var(--panel-strong);
        }
        .tab-panel {
            display: none;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
            scrollbar-gutter: stable;
        }
        .tab-panel.is-active { display: block; }
        .list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 10px;
        }
        .list-item {
            width: 100%;
            text-align: left;
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .list-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        .item-title { font-weight: 600; }
        .item-meta { color: var(--muted); font-size: 0.9rem; }
        .empty-state {
            padding: 16px;
            border-radius: 12px;
            border: 1px dashed var(--border);
            color: var(--muted);
            background: rgba(255, 255, 255, 0.5);
        }
        .section-title {
            margin: 18px 0 10px;
            font-size: 1rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            font-weight: 700;
            flex-shrink: 0;
        }
        .badge.success { background: var(--success); }
        .badge.warning { background: var(--warning); }

        .profile {
            display: flex;
            flex-direction: column;
            gap: 18px;
            min-height: 0;
            overflow: hidden;
        }
        .profile-header {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        .avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: var(--avatar-image);
            background-size: cover;
            background-position: center;
            border: 2px solid rgba(255, 255, 255, 0.6);
        }
        .profile-header h2 {
            margin: 0 0 4px;
            font-size: 1.4rem;
        }
        .profile-header p {
            margin: 0;
            color: var(--muted);
        }
        .xp-block {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 14px 16px;
            display: grid;
            gap: 8px;
        }
        .xp-meta {
            display: flex;
            justify-content: space-between;
            font-weight: 600;
        }
        .xp-bar {
            height: 12px;
            background: rgba(0, 0, 0, 0.08);
            border-radius: 999px;
            overflow: hidden;
        }
        .xp-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, var(--accent), #9f7bff);
            transition: width 0.3s ease;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .stat-card {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
        }
        .stat-card span { color: var(--muted); font-size: 0.85rem; }
        .stat-card strong { display: block; margin-top: 4px; font-size: 1.2rem; }
        .achievement-section {
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex: 1;
        }
        .achievement-list {
            display: grid;
            gap: 10px;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
            scrollbar-gutter: stable;
        }
        .achievement-item {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            display: grid;
            grid-template-columns: 40px 1fr;
            gap: 12px;
            align-items: start;
        }
        .achievement-item h4 { margin: 0; font-size: 1rem; }
        .achievement-item p { margin: 0; color: var(--muted); font-size: 0.9rem; }
        .achievement-item.is-locked {
            opacity: 0.65;
            border-style: dashed;
        }
        .achievement-item.is-unlocked {
            border-color: var(--success);
        }
        .achievement-badge {
            width: 38px;
            height: 38px;
            border-radius: 12px;
            background: rgba(88, 101, 242, 0.15);
            border: 1px solid var(--border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--accent);
        }
        .achievement-item.is-unlocked .achievement-badge {
            background: rgba(46, 204, 113, 0.18);
            color: var(--success);
            border-color: rgba(46, 204, 113, 0.4);
        }
        .achievement-details {
            display: grid;
            gap: 6px;
        }
        .achievement-title-row {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            gap: 8px;
            flex-wrap: wrap;
        }
        .achievement-tag {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(88, 101, 242, 0.14);
            color: var(--accent);
        }
        .achievement-meta {
            font-size: 0.85rem;
            color: var(--muted);
        }
        .achievement-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .achievement-reward {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
        }
        .trend-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 12px;
        }
        .trend-card {
            background: var(--panel-strong);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 14px;
            display: grid;
            gap: 6px;
        }
        .trend-card span { color: var(--muted); font-size: 0.85rem; }
        .trend-card strong { font-size: 1.1rem; }
        .trend-pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .trend-pill.up { background: rgba(46, 204, 113, 0.18); color: var(--success); }
        .trend-pill.down { background: rgba(231, 76, 60, 0.18); color: #c0392b; }
        .trend-pill.flat { background: rgba(243, 156, 18, 0.2); color: var(--warning); }
        .trend-note { margin-top: 10px; color: var(--muted); font-size: 0.85rem; }
        .item-details { display: grid; gap: 4px; }
        .item-details .item-meta { font-size: 0.85rem; }

        @media (max-width: 960px) {
            .sheet {
                grid-template-columns: 1fr;
                grid-template-rows: none;
                height: auto;
                flex: 0 0 auto;
            }
            .trend-grid {
                grid-template-columns: 1fr;
            }
            body {
                overflow: auto;
            }
            .card {
                overflow: visible;
            }
            .tab-panel {
                overflow: visible;
                padding-right: 0;
            }
            .achievement-section {
                flex: 0 0 auto;
            }
            .achievement-list {
                overflow: visible;
                padding-right: 0;
            }
        }
    
        /* Touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
        }
</style>
</head>
<body>
    <div class="sheet" data-testid="character-sheet">
        <section class="card" data-testid="character-sheet-left">
            <div class="tabs" role="tablist" aria-label="Karakterlap n&eacute;zetek" data-testid="character-sheet-tabs">
                <button class="tab-button is-active" type="button" data-tab="active" id="tab-button-active" role="tab" aria-selected="true" aria-controls="tab-active" tabindex="0" data-testid="character-sheet-tab-active">Akt&iacute;v k&uuml;ldet&eacute;seim</button>
                <button class="tab-button" type="button" data-tab="results" id="tab-button-results" role="tab" aria-selected="false" aria-controls="tab-results" tabindex="-1" data-testid="character-sheet-tab-results">Eredm&eacute;nyeim</button>
            </div>

            <div class="tab-panel is-active" id="tab-active" role="tabpanel" aria-labelledby="tab-button-active" data-testid="character-sheet-panel-active">
                <ul class="list" id="active-quest-list" data-testid="character-sheet-active-list"></ul>
                <div class="empty-state" id="active-empty" style="display:none;" data-testid="character-sheet-active-empty">M&eacute;g nincs akt&iacute;v k&uuml;ldet&eacute;s.</div>
            </div>

            <div class="tab-panel" id="tab-results" role="tabpanel" aria-labelledby="tab-button-results" hidden data-testid="character-sheet-panel-results">
                <div class="section-title">Kimaxolt modulok</div>
                <ul class="list" id="completed-quest-list" data-testid="character-sheet-completed-list"></ul>
                <div class="empty-state" id="completed-empty" style="display:none;" data-testid="character-sheet-completed-empty">M&eacute;g nincs kimaxolt modul.</div>

                <div class="section-title">Trend &ouml;sszegz&eacute;s</div>
                <div class="trend-grid" id="trend-grid" data-testid="character-sheet-trend-grid">
                    <div class="trend-card">
                        <span>Ut&oacute;bbi 5 teszt &aacute;tlaga</span>
                        <strong id="trend-last-avg">-</strong>
                        <span id="trend-last-count">0 teszt</span>
                    </div>
                    <div class="trend-card">
                        <span>El&#337;z&#337; 5 teszt &aacute;tlaga</span>
                        <strong id="trend-prev-avg">-</strong>
                        <span id="trend-prev-count">0 teszt</span>
                    </div>
                    <div class="trend-card">
                        <span>Trend</span>
                        <strong id="trend-delta">-</strong>
                        <span id="trend-direction" class="trend-pill flat">Nincs adat</span>
                    </div>
                </div>
                <div class="trend-note" id="trend-note"></div>
                <div class="empty-state" id="trend-empty" style="display:none;" data-testid="character-sheet-trend-empty">M&eacute;g nincs elegend&#337; teszteredm&eacute;ny trendhez.</div>

                <div class="section-title">T&eacute;mak&ouml;r betekint&eacute;s</div>
                <ul class="list" id="topic-insights-list" data-testid="character-sheet-topic-insights"></ul>
                <div class="empty-state" id="topic-insights-empty" style="display:none;" data-testid="character-sheet-topic-insights-empty">M&eacute;g nincsenek t&eacute;mak&ouml;r adatok.</div>

                <div class="section-title">Legut&oacute;bbi tesztek</div>
                <ul class="list" id="recent-results-list" data-testid="character-sheet-recent-results"></ul>
                <div class="empty-state" id="results-empty" style="display:none;" data-testid="character-sheet-results-empty">M&eacute;g nincsenek mentett teszteredm&eacute;nyek.</div>
            </div>
        </section>

        <section class="card profile" data-testid="character-sheet-right">
            <div class="profile-header" data-testid="character-sheet-profile-header">
                <div class="avatar"></div>
                <div>
                    <h2 id="profile-level">Lv. 1</h2>
                    <p id="profile-xp">&Ouml;sszes XP: 0</p>
                    <p id="profile-next">K&ouml;vetkez&#337; szint: 0 XP</p>
                </div>
            </div>

            <div class="xp-block" data-testid="character-sheet-xp">
                <div class="xp-meta">
                    <span id="xp-progress-text">0 / 50 XP</span>
                    <span id="xp-percent-text">0%</span>
                </div>
                <div class="xp-bar">
                    <div class="xp-bar-fill" id="xp-bar-fill"></div>
                </div>
            </div>

            <div class="stats-grid" data-testid="character-sheet-stats">
                <div class="stat-card">
                    <span>Akt&iacute;v k&uuml;ldet&eacute;sek</span>
                    <strong id="stat-active">0</strong>
                </div>
                <div class="stat-card">
                    <span>Kimaxolt modulok</span>
                    <strong id="stat-completed">0</strong>
                </div>
                <div class="stat-card">
                    <span>&Ouml;sszes teszt</span>
                    <strong id="stat-tests">0</strong>
                </div>
                <div class="stat-card">
                    <span>Gyakorl&aacute;s XP</span>
                    <strong id="stat-practice-xp">0</strong>
                </div>
            </div>

            <div class="achievement-section">
                <div class="section-title">Achievementek</div>
                <div class="achievement-list" id="achievement-list" data-testid="character-sheet-achievements"></div>
                <div class="empty-state" id="achievement-empty" style="display:none;" data-testid="character-sheet-achievements-empty">M&eacute;g nincsenek achievementek.</div>
            </div>
        </section>
    </div>

    <script>
        const dom = {
            tabs: document.querySelectorAll('.tab-button'),
            panels: {
                active: document.getElementById('tab-active'),
                results: document.getElementById('tab-results'),
            },
            activeList: document.getElementById('active-quest-list'),
            activeEmpty: document.getElementById('active-empty'),
            completedList: document.getElementById('completed-quest-list'),
            completedEmpty: document.getElementById('completed-empty'),
            resultsList: document.getElementById('recent-results-list'),
            resultsEmpty: document.getElementById('results-empty'),
            trendLastAvg: document.getElementById('trend-last-avg'),
            trendLastCount: document.getElementById('trend-last-count'),
            trendPrevAvg: document.getElementById('trend-prev-avg'),
            trendPrevCount: document.getElementById('trend-prev-count'),
            trendDelta: document.getElementById('trend-delta'),
            trendDirection: document.getElementById('trend-direction'),
            trendNote: document.getElementById('trend-note'),
            trendEmpty: document.getElementById('trend-empty'),
            topicInsightsList: document.getElementById('topic-insights-list'),
            topicInsightsEmpty: document.getElementById('topic-insights-empty'),
            profileLevel: document.getElementById('profile-level'),
            profileXp: document.getElementById('profile-xp'),
            profileNext: document.getElementById('profile-next'),
            xpText: document.getElementById('xp-progress-text'),
            xpPercent: document.getElementById('xp-percent-text'),
            xpBarFill: document.getElementById('xp-bar-fill'),
            statActive: document.getElementById('stat-active'),
            statCompleted: document.getElementById('stat-completed'),
            statTests: document.getElementById('stat-tests'),
            statPracticeXp: document.getElementById('stat-practice-xp'),
            achievementList: document.getElementById('achievement-list'),
            achievementEmpty: document.getElementById('achievement-empty'),
        };

        let summaryData = null;
        let resultsData = [];
        const topicLabelCache = {};
        const ACHIEVEMENT_FALLBACK = [
            {
                id: 'first_test',
                title: 'Els\u0151 teszteredm\u00e9ny',
                description: 'Els\u0151 sikeres teszt (jegy \u2265 2).',
                xpReward: 0,
                category: 'performance'
            },
            {
                id: 'hard_first',
                title: 'Neh\u00e9z harcos',
                description: 'Els\u0151 neh\u00e9z teszt sikeresen teljes\u00edtve.',
                xpReward: 50,
                category: 'difficulty'
            },
            {
                id: 'hard_perfect',
                title: 'T\u00f6k\u00e9letes vizsga',
                description: '5-\u00f6s jegy neh\u00e9z teszten.',
                xpReward: 75,
                category: 'performance'
            },
            {
                id: 'streak_5',
                title: 'Sorozatgy\u0151ztes',
                description: '5 egym\u00e1s ut\u00e1ni j\u00f3 eredm\u00e9ny.',
                xpReward: 50,
                category: 'performance'
            },
            {
                id: 'subtopic_master',
                title: 'Alt\u00e9ma z\u00e1r\u00f3',
                description: 'Egy alt\u00e9ma kimaxol\u00e1sa.',
                xpReward: 80,
                category: 'structure'
            },
            {
                id: 'main_topic_master',
                title: 'F\u0151t\u00e9ma mester',
                description: 'Egy f\u0151t\u00e9ma kimaxol\u00e1sa.',
                xpReward: 120,
                category: 'structure'
            },
            {
                id: 'emelt_bajnok',
                title: 'Emelt bajnok',
                description: 'Emelt modulz\u00e1r\u00f3 sikeres teljes\u00edt\u00e9se.',
                xpReward: 150,
                category: 'difficulty'
            },
            {
                id: 'xp_collector_1000',
                title: 'XP gy\u0171jt\u0151',
                description: '\u00d6sszegy\u0171jt\u00f6tt\u00e9l 1000 XP-t.',
                xpReward: 100,
                category: 'special'
            },
            {
                id: 'level_up',
                title: 'Szintl\u00e9p\u0151',
                description: 'El\u00e9rt\u00e9l egy \u00faj szintet.',
                xpReward: 0,
                category: 'special'
            }
        ];
        const LOCALE = 'hu-HU';
        const numberFormatter = new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 2 });
        const TREND_WINDOW = 5;
        const TOPIC_INSIGHT_LIMIT = 5;
        const TREND_THRESHOLD = 2;
        const FALLBACK_TOPIC_LABEL = 'Ismeretlen témakör';
        const CATEGORY_LABELS = {
            performance: 'Teljes\u00edtm\u00e9ny',
            difficulty: 'Neh\u00e9zs\u00e9gi szint',
            structure: 'Strukt\u00fara',
            special: 'Speci\u00e1lis'
        };
        const CATEGORY_BADGES = {
            performance: 'T',
            difficulty: 'N',
            structure: 'ST',
            special: 'SP'
        };

        function formatNumber(value, fallback = '-') {
            if (value === null || value === undefined || value === '') return fallback;
            const num = Number(value);
            return Number.isFinite(num) ? numberFormatter.format(num) : fallback;
        }

        function formatDate(value) {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString(LOCALE);
        }

        function formatPercent(value, fallback = '-') {
            if (!Number.isFinite(value)) return fallback;
            return `${formatNumber(value, fallback)}%`;
        }

        function formatSigned(value, fallback = '-') {
            if (!Number.isFinite(value)) return fallback;
            const sign = value > 0 ? '+' : value < 0 ? '' : '';
            return `${sign}${formatNumber(value, fallback)}`;
        }

        function toTimestamp(value) {
            const time = new Date(value).getTime();
            return Number.isFinite(time) ? time : null;
        }

        function getResultScore(result) {
            const percent = Number(result && result.percentage);
            if (Number.isFinite(percent)) return percent;
            const grade = Number(result && result.grade);
            if (Number.isFinite(grade)) return grade * 20;
            return null;
        }

        function getResultGrade(result) {
            const grade = Number(result && result.grade);
            return Number.isFinite(grade) ? grade : null;
        }

        function getSortedResults(results) {
            if (!Array.isArray(results)) return [];
            const mapped = results
                .map((result) => ({ result, ts: toTimestamp(result && result.timestamp) }))
                .filter((entry) => entry.ts !== null);
            mapped.sort((a, b) => b.ts - a.ts);
            return mapped.map((entry) => entry.result);
        }

        function average(values) {
            if (!values.length) return null;
            const total = values.reduce((sum, value) => sum + value, 0);
            return total / values.length;
        }

        function parseHexColor(hex) {
            const match = (hex || '').trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (!match) return null;
            const raw = match[1];
            const full = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
            return {
                r: parseInt(full.slice(0, 2), 16),
                g: parseInt(full.slice(2, 4), 16),
                b: parseInt(full.slice(4, 6), 16),
            };
        }

        function isDarkColor(hex) {
            const rgb = parseHexColor(hex);
            if (!rgb) return false;
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            return luminance < 0.5;
        }

        function normalizeOverlayColor(value) {
            const minAlpha = 0.35;
            const fallback = `rgba(15, 18, 22, ${minAlpha})`;
            if (!value || typeof value !== 'string') return fallback;
            const trimmed = value.trim();
            const rgbaMatch = trimmed.match(/^rgba?\\(([^)]+)\\)$/i);
            if (rgbaMatch) {
                const parts = rgbaMatch[1].split(',').map(part => part.trim());
                const r = Number(parts[0]);
                const g = Number(parts[1]);
                const b = Number(parts[2]);
                if ([r, g, b].some(Number.isNaN)) return fallback;
                const alpha = parts.length > 3 ? Number(parts[3]) : minAlpha;
                const safeAlpha = Math.min(0.9, Math.max(minAlpha, Number.isNaN(alpha) ? minAlpha : alpha));
                return `rgba(${r}, ${g}, ${b}, ${safeAlpha})`;
            }
            const hexMatch = trimmed.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hexMatch) {
                const rgb = parseHexColor(trimmed);
                if (!rgb) return fallback;
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${minAlpha})`;
            }
            return fallback;
        }

        function applySettings(settings) {
            if (!settings) return;
            const contentBg = settings.contentBg || '#f5f7fb';
            const isDark = isDarkColor(contentBg);
            const rawOpacity = Number(settings.moduleCardOpacity);
            const panelAlpha = Number.isFinite(rawOpacity) ? Math.min(1, Math.max(0.5, rawOpacity)) : 0.92;
            const panelStrongAlpha = Math.min(1, panelAlpha + 0.08);
            const panelRgb = isDark ? '20, 24, 30' : '255, 255, 255';
            document.documentElement.style.setProperty('--accent', settings.buttonBg || '#5865f2');
            document.documentElement.style.setProperty('--overlay', normalizeOverlayColor(settings.contentOverlay));
            document.documentElement.style.setProperty('--panel', `rgba(${panelRgb}, ${panelAlpha})`);
            document.documentElement.style.setProperty('--panel-strong', `rgba(${panelRgb}, ${panelStrongAlpha})`);
            document.documentElement.style.setProperty('--text', isDark ? '#f3f4f6' : '#1f2933');
            document.documentElement.style.setProperty('--muted', isDark ? '#cbd5f5' : '#6b7280');
            document.documentElement.style.setProperty('--border', isDark ? 'rgba(255, 255, 255, 0.12)' : 'rgba(15, 23, 42, 0.1)');
            if (settings.avatarImage) {
                document.documentElement.style.setProperty('--avatar-image', settings.avatarImage);
            } else {
                document.documentElement.style.removeProperty('--avatar-image');
            }
            document.body.style.backgroundColor = 'transparent';
            document.body.style.backgroundImage = 'none';
        }

        function getTopicLabel(topicId) {
            if (!topicId) return '';
            if (topicLabelCache[topicId]) return topicLabelCache[topicId];
            try {
                const link = window.parent && window.parent.document
                    ? window.parent.document.querySelector(`[data-topic-id="${topicId}"]`)
                    : null;
                if (link) {
                    const textNode = Array.from(link.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.nodeValue.trim());
                    const label = textNode ? textNode.nodeValue.trim() : link.textContent.trim();
                    const cleanLabel = label.replace(/\u00ad/g, '').trim();
                    topicLabelCache[topicId] = cleanLabel;
                    return cleanLabel;
                }
            } catch (error) {
                // ignore cross-context access issues
            }
            topicLabelCache[topicId] = FALLBACK_TOPIC_LABEL;
            return FALLBACK_TOPIC_LABEL;
        }

        function resolveTopicName(result) {
            if (result && result.topicNameHu) return result.topicNameHu;
            if (result && result.topicName) return result.topicName;
            return getTopicLabel(result && result.topicId);
        }

        function navigateToTopic(topicId) {
            if (!topicId) return;
            try {
                const link = window.parent && window.parent.document
                    ? window.parent.document.querySelector(`[data-topic-id="${topicId}"]`)
                    : null;
                if (link) {
                    link.click();
                }
            } catch (error) {
                // ignore navigation failures
            }
        }

        function getQuestEntries() {
            const quests = summaryData && summaryData.quests ? summaryData.quests : {};
            const entries = [];
            const mainTopics = quests.mainTopics && typeof quests.mainTopics === 'object' ? quests.mainTopics : {};
            const subtopics = quests.subtopics && typeof quests.subtopics === 'object' ? quests.subtopics : {};
            const topics = quests.topics && typeof quests.topics === 'object' ? quests.topics : {};
            Object.entries(mainTopics).forEach(([topicId, status]) => {
                entries.push({ topicId, status, scope: 'main' });
            });
            Object.entries(subtopics).forEach(([topicId, status]) => {
                entries.push({ topicId, status, scope: 'sub' });
            });
            Object.entries(topics).forEach(([topicId, status]) => {
                entries.push({ topicId, status, scope: 'topic' });
            });
            return entries;
        }

        function getQuestEntriesByStatus(status) {
            return getQuestEntries().filter(entry => entry.status === status);
        }

        function getScopeLabel(scope) {
            if (scope === 'main') return 'Főtéma';
            if (scope === 'sub') return 'Altéma';
            return 'Témakör';
        }

        function getBestGrade(topicData) {
            let best = null;
            Object.values(topicData || {}).forEach((value) => {
                const grade = typeof value === 'number' ? value : value && typeof value.grade === 'number' ? value.grade : null;
                if (grade === null) return;
                if (best === null || grade > best) best = grade;
            });
            return best;
        }

        function renderList(listEl, emptyEl, items, builder) {
            listEl.innerHTML = '';
            if (!items.length) {
                emptyEl.style.display = 'block';
                return;
            }
            emptyEl.style.display = 'none';
            items.forEach(item => {
                listEl.appendChild(builder(item));
            });
        }

        function renderActiveQuests() {
            const activeEntries = getQuestEntriesByStatus('ACTIVE');
            renderList(dom.activeList, dom.activeEmpty, activeEntries, (entry) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-item';
                const scopeLabel = getScopeLabel(entry.scope);
                const metaText = `Aktív küldetés · ${scopeLabel}`;
                button.innerHTML = `<span class="item-title">${getTopicLabel(entry.topicId)}</span><span class="item-meta">${metaText}</span>`;
                button.addEventListener('click', () => navigateToTopic(entry.topicId));
                li.appendChild(button);
                return li;
            });
        }

        function renderCompletedQuests() {
            const completedEntries = getQuestEntriesByStatus('COMPLETED');
            renderList(dom.completedList, dom.completedEmpty, completedEntries, (entry) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-item';
                const bestGrade = getBestGrade(summaryData && summaryData.completions ? summaryData.completions[entry.topicId] : null);
                const scopeLabel = getScopeLabel(entry.scope);
                const hasBestGrade = bestGrade !== null && bestGrade !== undefined;
                const statusLabel = 'Kimaxolt küldetés';
                const metaParts = [statusLabel];
                if (hasBestGrade) {
                    metaParts.push(`Legjobb jegy: ${formatNumber(bestGrade, '-')}`);
                }
                metaParts.push(scopeLabel);
                const metaText = metaParts.join(' · ');
                button.innerHTML = `<span class="item-title">${getTopicLabel(entry.topicId)}</span><span class="item-meta">${metaText}</span>`;
                button.addEventListener('click', () => navigateToTopic(entry.topicId));
                li.appendChild(button);
                return li;
            });
        }

        function renderRecentResults() {
            const recent = getSortedResults(resultsData).slice(0, 5);
            renderList(dom.resultsList, dom.resultsEmpty, recent, (result) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-item';
                const gradeValue = result && result.grade !== null && result.grade !== undefined && result.grade !== ''
                    ? Number(result.grade)
                    : Number.NaN;
                const gradeText = Number.isFinite(gradeValue) ? formatNumber(gradeValue, '-') : '-';
                button.innerHTML = `<span class="item-title">${getTopicLabel(result.topicId || '')}</span><span class="item-meta">Jegy: ${gradeText}</span>`;
                if (result.topicId) {
                    button.addEventListener('click', () => navigateToTopic(result.topicId));
                }
                li.appendChild(button);
                return li;
            });
        }

        function renderStats(sortedResults) {
            const entries = getQuestEntries();
            const activeCount = entries.filter(entry => entry.status === 'ACTIVE').length;
            const completedCount = entries.filter(entry => entry.status === 'COMPLETED').length;
            const testsCount = sortedResults ? sortedResults.length : 0;
            const practiceXp = summaryData && summaryData.practiceXp
                ? Object.values(summaryData.practiceXp).reduce((sum, value) => sum + Number(value || 0), 0)
                : 0;
            dom.statActive.textContent = formatNumber(activeCount, '0');
            dom.statCompleted.textContent = formatNumber(completedCount, '0');
            dom.statTests.textContent = formatNumber(testsCount, '0');
            dom.statPracticeXp.textContent = formatNumber(practiceXp, '0');
        }

        function renderAchievements() {
            const catalog = Array.isArray(summaryData && summaryData.achievementCatalog)
                ? summaryData.achievementCatalog
                : ACHIEVEMENT_FALLBACK;
            const states = summaryData && summaryData.achievements ? summaryData.achievements : {};
            dom.achievementList.innerHTML = '';
            dom.achievementList.style.display = '';
            if (!catalog.length) {
                dom.achievementEmpty.style.display = 'block';
                dom.achievementList.style.display = 'none';
                return;
            }
            const unlockedAchievements = catalog
                .map((achievement) => {
                    const state = states[achievement.id] || {};
                    const isUnlocked = Boolean(state.isUnlocked || state.unlockedAt);
                    return isUnlocked ? { achievement, state } : null;
                })
                .filter(Boolean);
            if (!unlockedAchievements.length) {
                dom.achievementEmpty.style.display = 'block';
                dom.achievementList.style.display = 'none';
                return;
            }
            dom.achievementEmpty.style.display = 'none';
            unlockedAchievements.forEach(({ achievement, state }) => {
                const card = document.createElement('div');
                card.className = 'achievement-item is-unlocked';
                card.dataset.achievementId = achievement.id;
                const titleText = achievement.title || achievement.nameHu || 'Ismeretlen achievement';
                const description = achievement.description || '';
                const category = achievement.category || 'special';
                const categoryLabel = CATEGORY_LABELS[category] || 'Speci\u00e1lis';
                const badgeText = CATEGORY_BADGES[category] || 'SP';
                const rewardValue = Number(Number.isFinite(state.grantedXp)
                    ? state.grantedXp
                    : (achievement.xpReward || 0));
                const rewardText = rewardValue > 0
                    ? `+${formatNumber(rewardValue, '0')} XP`
                    : 'Jelv\u00e9ny';
                let metaText = 'Megszerezve';
                if (state.unlockedAt) {
                    const dateLabel = formatDate(state.unlockedAt);
                    if (dateLabel) {
                        metaText = `Megszerezve: ${dateLabel}`;
                    }
                }
                card.innerHTML = `
                    <div class="achievement-badge" aria-hidden="true">${badgeText}</div>
                    <div class="achievement-details">
                        <div class="achievement-title-row">
                            <h4>${titleText}</h4>
                            <span class="achievement-tag">${categoryLabel}</span>
                        </div>
                        <p>${description}</p>
                        <div class="achievement-footer">
                            <span class="achievement-meta">${metaText}</span>
                            <span class="achievement-reward">Jutalom: ${rewardText}</span>
                        </div>
                    </div>`;
                dom.achievementList.appendChild(card);
            });
        }

        function renderProfile() {
            if (!summaryData || !summaryData.level) return;
            const level = summaryData.level.level || 1;
            const levelName = summaryData.level.levelName || "";
            const xpTotal = summaryData.xp || 0;
            const xpForNext = Number.isFinite(summaryData.level.xpForNext) ? summaryData.level.xpForNext : 0;
            const xpInto = Number.isFinite(summaryData.level.xpIntoLevel) ? summaryData.level.xpIntoLevel : 0;
            const xpToNext = Number.isFinite(summaryData.level.xpToNext)
                ? summaryData.level.xpToNext
                : Math.max(0, xpForNext - xpInto);
            const isMaxLevel = xpForNext <= 0;
            const safeRequired = isMaxLevel ? Math.max(1, xpInto) : xpForNext;
            const percent = Math.min(100, Math.round((xpInto / safeRequired) * 100));
            const levelText = formatNumber(level, '1');
            dom.profileLevel.textContent = levelName ? `Lv. ${levelText} - ${levelName}` : `Lv. ${levelText}`;
            dom.profileXp.textContent = `\u00d6sszes XP: ${formatNumber(xpTotal, '0')}`;
            dom.profileNext.textContent = isMaxLevel
                ? "K\u00f6vetkez\u0151 szint: Max"
                : `K\u00f6vetkez\u0151 szint: ${formatNumber(xpToNext, '0')} XP`;
            dom.xpText.textContent = isMaxLevel
                ? `${formatNumber(xpInto, '0')} XP`
                : `${formatNumber(xpInto, '0')} / ${formatNumber(xpForNext, '0')} XP`;
            dom.xpPercent.textContent = `${formatNumber(percent, '0')}%`;
            dom.xpBarFill.style.width = `${percent}%`;
        }

        function buildTrendSummary(sortedResults) {
            const scored = sortedResults
                .map((result) => ({ score: getResultScore(result) }))
                .filter((entry) => Number.isFinite(entry.score));
            const last = scored.slice(0, TREND_WINDOW).map((entry) => entry.score);
            const prev = scored.slice(TREND_WINDOW, TREND_WINDOW * 2).map((entry) => entry.score);
            const lastAvg = average(last);
            const prevAvg = average(prev);
            const delta = Number.isFinite(lastAvg) && Number.isFinite(prevAvg) ? lastAvg - prevAvg : null;
            const direction = delta === null
                ? 'none'
                : delta > TREND_THRESHOLD ? 'up' : delta < -TREND_THRESHOLD ? 'down' : 'flat';
            return {
                total: scored.length,
                lastCount: last.length,
                prevCount: prev.length,
                lastAvg,
                prevAvg,
                delta,
                direction,
            };
        }

        function getDirectionLabel(direction) {
            if (direction === 'up') return { label: 'Emelked\u0151', className: 'trend-pill up' };
            if (direction === 'down') return { label: 'Cs\u00f6kken\u0151', className: 'trend-pill down' };
            if (direction === 'flat') return { label: 'Stabil', className: 'trend-pill flat' };
            return { label: 'Nincs adat', className: 'trend-pill flat' };
        }

        function buildTopicInsights(sortedResults) {
            const grouped = new Map();
            sortedResults.forEach((result) => {
                const topicId = result && result.topicId ? result.topicId : null;
                const key = topicId || (result && result.topicName ? result.topicName : 'ismeretlen');
                if (!grouped.has(key)) {
                    grouped.set(key, {
                        key,
                        topicId,
                        title: resolveTopicName(result),
                        entries: [],
                    });
                }
                const score = getResultScore(result);
                const grade = getResultGrade(result);
                const ts = toTimestamp(result && result.timestamp);
                grouped.get(key).entries.push({ score, grade, ts });
            });

            const insights = [];
            grouped.forEach((group) => {
                const validEntries = group.entries.filter((entry) => Number.isFinite(entry.score) && entry.ts !== null);
                validEntries.sort((a, b) => b.ts - a.ts);
                if (!validEntries.length) return;
                const scores = validEntries.map((entry) => entry.score);
                const avgScore = average(scores);
                const avgGrade = average(validEntries.map((entry) => entry.grade).filter((value) => Number.isFinite(value)));
                const last = validEntries[0];
                const prev = validEntries[1];
                const delta = last && prev ? last.score - prev.score : null;
                let direction = 'flat';
                if (delta === null) {
                    direction = 'none';
                } else if (delta > TREND_THRESHOLD) {
                    direction = 'up';
                } else if (delta < -TREND_THRESHOLD) {
                    direction = 'down';
                }
                insights.push({
                    topicId: group.topicId,
                    title: group.title || group.key,
                    attempts: validEntries.length,
                    avgScore,
                    avgGrade,
                    lastScore: last.score,
                    delta,
                    direction,
                    lastTs: last.ts,
                });
            });
            insights.sort((a, b) => b.lastTs - a.lastTs);
            return insights.slice(0, TOPIC_INSIGHT_LIMIT);
        }

        function renderTrendSummary(sortedResults) {
            const summary = buildTrendSummary(sortedResults);
            if (!summary.total) {
                dom.trendEmpty.style.display = 'block';
                dom.trendNote.textContent = '';
                dom.trendLastAvg.textContent = '-';
                dom.trendPrevAvg.textContent = '-';
                dom.trendDelta.textContent = '-';
                dom.trendLastCount.textContent = '0 teszt';
                dom.trendPrevCount.textContent = '0 teszt';
                const label = getDirectionLabel('none');
                dom.trendDirection.textContent = label.label;
                dom.trendDirection.className = label.className;
                return;
            }
            dom.trendEmpty.style.display = 'none';
            dom.trendLastAvg.textContent = formatPercent(summary.lastAvg, '-');
            dom.trendPrevAvg.textContent = summary.prevCount ? formatPercent(summary.prevAvg, '-') : '-';
            dom.trendLastCount.textContent = `${summary.lastCount} teszt`;
            dom.trendPrevCount.textContent = `${summary.prevCount} teszt`;
            if (summary.prevCount) {
                dom.trendDelta.textContent = `${formatSigned(summary.delta, '-')}\u0025`;
            } else {
                dom.trendDelta.textContent = '-';
            }
            const label = getDirectionLabel(summary.direction);
            dom.trendDirection.textContent = label.label;
            dom.trendDirection.className = label.className;
            if (summary.prevCount) {
                dom.trendNote.textContent = 'A trend az ut\u00f3bbi \u00e9s az azt megel\u0151z\u0151 5 teszt \u00e1tlag\u00e1t hasonl\u00edtja \u00f6ssze.';
            } else {
                dom.trendNote.textContent = 'T\u00f6lts ki legal\u00e1bb 6 tesztet a r\u00e9szletes trendhez.';
            }
        }

        function renderTopicInsights(sortedResults) {
            const insights = buildTopicInsights(sortedResults);
            dom.topicInsightsList.innerHTML = '';
            if (!insights.length) {
                dom.topicInsightsEmpty.style.display = 'block';
                return;
            }
            dom.topicInsightsEmpty.style.display = 'none';
            insights.forEach((insight) => {
                const li = document.createElement('li');
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'list-item';
                const avgText = Number.isFinite(insight.avgScore) ? formatPercent(insight.avgScore, '-') : '-';
                const lastText = Number.isFinite(insight.lastScore) ? formatPercent(insight.lastScore, '-') : '-';
                const attemptsText = `${formatNumber(insight.attempts, '0')} pr\u00f3ba`;
                const gradeText = Number.isFinite(insight.avgGrade)
                    ? `\u00c1tlagjegy: ${formatNumber(insight.avgGrade, '-')}`
                    : 'Nincs \u00e1tlagjegy';
                const deltaText = insight.delta === null ? '-' : `${formatSigned(insight.delta, '-')}\u0025`;
                const directionLabel = getDirectionLabel(insight.direction);
                button.innerHTML = `<div class="item-details"><span class="item-title">${insight.title || 'Ismeretlen'}</span><span class="item-meta">${gradeText} \u00b7 \u00c1tlag: ${avgText} \u00b7 Ut\u00f3bbi: ${lastText} \u00b7 ${attemptsText}</span></div><span class="${directionLabel.className}">${directionLabel.label} ${deltaText}</span>`;
                if (insight.topicId) {
                    button.addEventListener('click', () => navigateToTopic(insight.topicId));
                }
                li.appendChild(button);
                dom.topicInsightsList.appendChild(li);
            });
        }

        function renderAll() {
            const sortedResults = getSortedResults(resultsData);
            renderProfile();
            renderActiveQuests();
            renderCompletedQuests();
            renderTrendSummary(sortedResults);
            renderTopicInsights(sortedResults);
            renderRecentResults();
            renderStats(sortedResults);
            renderAchievements();
        }

        function setActiveTab(tab) {
            if (!tab) return;
            const target = tab.dataset.tab;
            dom.tabs.forEach((btn) => {
                const isActive = btn === tab;
                btn.classList.toggle('is-active', isActive);
                btn.setAttribute('aria-selected', String(isActive));
                btn.setAttribute('tabindex', isActive ? '0' : '-1');
            });
            Object.entries(dom.panels).forEach(([key, panel]) => {
                const isActive = key === target;
                panel.classList.toggle('is-active', isActive);
                panel.hidden = !isActive;
            });
        }

        function focusTabByOffset(currentTab, offset) {
            const tabs = Array.from(dom.tabs);
            const currentIndex = tabs.indexOf(currentTab);
            if (currentIndex === -1) return;
            const nextIndex = (currentIndex + offset + tabs.length) % tabs.length;
            const nextTab = tabs[nextIndex];
            nextTab.focus();
            setActiveTab(nextTab);
        }

        function focusTabEdge(direction) {
            const tabs = Array.from(dom.tabs);
            if (!tabs.length) return;
            const nextTab = direction === 'start' ? tabs[0] : tabs[tabs.length - 1];
            nextTab.focus();
            setActiveTab(nextTab);
        }

        dom.tabs.forEach((tab) => {
            tab.addEventListener('click', () => setActiveTab(tab));
            tab.addEventListener('keydown', (event) => {
                if (event.key === 'ArrowRight') {
                    event.preventDefault();
                    focusTabByOffset(tab, 1);
                } else if (event.key === 'ArrowLeft') {
                    event.preventDefault();
                    focusTabByOffset(tab, -1);
                } else if (event.key === 'Home') {
                    event.preventDefault();
                    focusTabEdge('start');
                } else if (event.key === 'End') {
                    event.preventDefault();
                    focusTabEdge('end');
                }
            });
        });

        setActiveTab(document.querySelector('.tab-button.is-active') || dom.tabs[0]);

        document.addEventListener('DOMContentLoaded', () => {
            window.parent.postMessage({ type: 'request-xp-summary' }, '*');
            window.parent.postMessage({ type: 'get-all-results' }, '*');
            window.parent.postMessage({ type: 'request-settings' }, '*');
        });

        window.addEventListener('message', (event) => {
            if (event.data.type === 'xp-summary') {
                summaryData = event.data.summary;
                renderAll();
            }
            if (event.data.type === 'all-results-response') {
                resultsData = Array.isArray(event.data.results) ? event.data.results : [];
                renderAll();
            }
            if (event.data.type === 'apply-settings') {
                applySettings(event.data.settings);
            }
        });
    </script>
</body>
</html>
