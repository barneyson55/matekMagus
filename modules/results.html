<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Eredményeim</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --brand-primary: #4A55A2;
            --brand-secondary: #7895CB;
            --text-dark: #2C3333;
            --text-light: #576574;
            --bg-main: #FBFBFF;
            --bg-card: rgba(255, 255, 255, var(--module-card-opacity, 1));
            --border-color: #EAEFF2;
            --grade-1: #E74C3C;
            --grade-2: #F39C12;
            --grade-3: #F1C40F;
            --grade-4: #27AE60;
            --grade-5: #2ECC71;
            --font-main: 'Inter', sans-serif;
            --success: #2ECC71;
            --danger: #E74C3C;
            --panel-bg: var(--bg-card);
            --overlay: rgba(255, 255, 255, 0.8);
        }
        html, body { background-color: transparent; }
        body {
            font-family: var(--font-main);
            color: var(--text-dark);
            padding: 40px;
            margin: 0;
            min-height: 100vh;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: var(--overlay);
            pointer-events: none;
            z-index: 0;
        }
        .results-shell {
            position: relative;
            z-index: 1;
            display: grid;
            gap: 24px;
        }
        h1 { font-size: 2.5em; color: var(--text-dark); font-weight: 700; margin-bottom: 30px; border-bottom: 2px solid var(--brand-background); padding-bottom: 15px; }
        #results-container { display: grid; gap: 20px; }
        .result-item { background-color: var(--panel-bg); border-radius: 12px; padding: 20px; box-shadow: 0 5px 20px -10px rgba(0,0,0,0.1); border: 1px solid var(--border-color); display: grid; grid-template-columns: auto 1fr auto; align-items: center; gap: 20px; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .result-item:hover { transform: translateY(-3px); box-shadow: 0 8px 25px -8px rgba(0,0,0,0.15); }
        .grade-badge { font-size: 1.8em; font-weight: 700; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .grade-1 { background-color: var(--grade-1); } .grade-2 { background-color: var(--grade-2); } .grade-3 { background-color: var(--grade-3); } .grade-4 { background-color: var(--grade-4); } .grade-5 { background-color: var(--grade-5); }
        .result-details { min-width: 0; }
        .result-details h3 { margin: 0 0 5px 0; font-size: 1.2em; color: var(--brand-primary); overflow-wrap: anywhere; }
        .result-details p { margin: 0; color: var(--text-light); font-size: 0.9em; overflow-wrap: anywhere; }
        .result-actions { display: flex; justify-content: flex-end; }
        .result-actions button { padding: 10px 18px; border: none; background-color: var(--brand-secondary); color: white; font-weight: 500; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        .result-actions button:hover { background-color: var(--brand-primary); }
        .no-results { text-align: center; padding: 50px; color: #7f8c8d; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: var(--panel-bg); margin: auto; padding: 30px; border: 1px solid var(--border-color); border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; background: none; border: none; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .modal-close:focus-visible { outline: 2px solid var(--brand-primary); outline-offset: 2px; }
        .question-review { border-bottom: 1px solid var(--border-color); padding: 15px 0; }
        .question-review:last-child { border-bottom: none; }
        .user-answer { padding: 8px; border-radius: 5px; margin-top: 5px; border: 2px solid; }
        .user-answer.correct { background-color: #eafaf1; border-color: var(--success); }
        .user-answer.incorrect { background-color: #fbeeed; border-color: var(--danger); }
        .correct-answer { margin-top: 10px; font-weight: 500; color: var(--success); }
        .xp-summary { background-color: var(--panel-bg); border-radius: 16px; padding: 24px; border: 1px solid var(--border-color); box-shadow: 0 15px 40px -20px rgba(0,0,0,0.25); margin-bottom: 30px; }
        .xp-summary h2 { margin: 0 0 10px 0; }
        .xp-summary p { margin: 0; color: var(--text-light); }
        .xp-summary .xp-meta { display: flex; justify-content: space-between; align-items: center; font-weight: 600; margin-bottom: 12px; }
        .xp-progress { height: 12px; border-radius: 999px; background-color: #e5e7eb; overflow: hidden; }
        .xp-progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary)); width: 0%; transition: width 0.4s; }
        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .insight-card { background-color: var(--panel-bg); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 12px 30px -18px rgba(0,0,0,0.2); }
        .insight-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; gap: 12px; flex-wrap: wrap; }
        .insight-header h2 { margin: 0; font-size: 1.1em; color: var(--brand-primary); }
        .insight-sub { color: var(--text-light); font-size: 0.85em; }
        .metric-grid { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 12px; }
        .metric { background-color: rgba(255, 255, 255, 0.7); border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 14px; display: grid; gap: 6px; }
        .metric span { color: var(--text-light); font-size: 0.85em; }
        .metric strong { font-size: 1.1em; color: var(--text-dark); }
        .trend-chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-weight: 600; font-size: 0.75em; }
        .trend-chip.up { background-color: rgba(46, 204, 113, 0.15); color: var(--grade-5); }
        .trend-chip.down { background-color: rgba(231, 76, 60, 0.15); color: var(--grade-1); }
        .trend-chip.flat { background-color: rgba(241, 196, 15, 0.18); color: #b9770e; }
        .trend-note { margin-top: 10px; color: var(--text-light); font-size: 0.9em; }
        .topic-list { display: grid; gap: 10px; }
        .topic-item { border: 1px solid var(--border-color); border-radius: 12px; padding: 12px 14px; display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; background-color: rgba(255, 255, 255, 0.6); }
        .topic-info { display: grid; gap: 4px; min-width: 0; }
        .topic-info strong { font-size: 1rem; overflow-wrap: anywhere; }
        .topic-meta { color: var(--text-light); font-size: 0.85em; }
        .insight-empty { text-align: center; padding: 16px; color: var(--text-light); border: 1px dashed var(--border-color); border-radius: 12px; background: rgba(255, 255, 255, 0.4); }

        @media (max-width: 700px) {
            .metric-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) {
            .result-item { grid-template-columns: auto 1fr; }
            .result-actions { grid-column: 1 / -1; justify-content: flex-start; }
        }

        @media (max-width: 600px) {
            body { padding: 20px; }
        }
    
        /* Touch targets */
        button {
            min-height: 44px;
            min-width: 44px;
            font: inherit;
        }
</style>
</head>
<body>
    <div class="results-shell">
        <div class="xp-summary">
            <div class="xp-meta">
                <span>Szint <span id="results-level">1</span></span>
                <span id="results-total-xp">0 XP</span>
            </div>
            <div class="xp-progress">
                <div class="xp-progress-fill" id="results-xp-progress"></div>
            </div>
            <p id="results-xp-text">Következő szint: 50 XP</p>
        </div>
        <div class="insights-grid">
            <div class="insight-card" id="trend-card">
                <div class="insight-header">
                    <h2>Trend &ouml;sszegz&eacute;s</h2>
                    <span class="insight-sub" id="trend-window-label">Ut&oacute;bbi 10 teszt alapj&aacute;n</span>
                </div>
                <div class="metric-grid" id="trend-metrics">
                    <div class="metric">
                        <span>Ut&oacute;bbi 5 teszt &aacute;tlaga</span>
                        <strong id="trend-last-avg">-</strong>
                        <span id="trend-last-count">0 teszt</span>
                    </div>
                    <div class="metric">
                        <span>El&#337;z&#337; 5 teszt &aacute;tlaga</span>
                        <strong id="trend-prev-avg">-</strong>
                        <span id="trend-prev-count">0 teszt</span>
                    </div>
                    <div class="metric">
                        <span>Trend</span>
                        <strong id="trend-delta">-</strong>
                        <span id="trend-direction" class="trend-chip flat">Nincs adat</span>
                    </div>
                </div>
                <div class="trend-note" id="trend-note"></div>
                <div class="insight-empty" id="trend-empty" style="display:none;">M&eacute;g nincs elegend&#337; teszteredm&eacute;ny trendhez.</div>
            </div>
            <div class="insight-card" id="topic-card">
                <div class="insight-header">
                    <h2>T&eacute;mak&ouml;r betekint&eacute;s</h2>
                    <span class="insight-sub" id="topic-summary">Legut&oacute;bbi aktivit&aacute;s alapj&aacute;n</span>
                </div>
                <div class="topic-list" id="topic-insights-list"></div>
                <div class="insight-empty" id="topic-insights-empty" style="display:none;">M&eacute;g nincsenek t&eacute;mak&ouml;r adatok.</div>
            </div>
        </div>
        <div id="results-container"></div>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close-btn" type="button" aria-label="Bezárás">&times;</button>
            <div id="modal-body"></div>
        </div>
    </div>

    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"
        onload="renderAllMath()">
    </script>
    <script>
        function renderAllMath() { renderMathInElement(document.body, { delimiters: [ {left: '$', right: '$', display: false} ] }); }

        const container = document.getElementById('results-container');
        const modal = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const resultsLevel = document.getElementById('results-level');
        const resultsTotalXp = document.getElementById('results-total-xp');
        const resultsXpProgress = document.getElementById('results-xp-progress');
        const resultsXpText = document.getElementById('results-xp-text');
        const trendWindowLabel = document.getElementById('trend-window-label');
        const trendLastAvg = document.getElementById('trend-last-avg');
        const trendLastCount = document.getElementById('trend-last-count');
        const trendPrevAvg = document.getElementById('trend-prev-avg');
        const trendPrevCount = document.getElementById('trend-prev-count');
        const trendDelta = document.getElementById('trend-delta');
        const trendDirection = document.getElementById('trend-direction');
        const trendNote = document.getElementById('trend-note');
        const trendEmpty = document.getElementById('trend-empty');
        const topicInsightsList = document.getElementById('topic-insights-list');
        const topicInsightsEmpty = document.getElementById('topic-insights-empty');
        const LOCALE = 'hu-HU';
        const numberFormatter = new Intl.NumberFormat(LOCALE, { maximumFractionDigits: 2 });
        const TREND_WINDOW = 5;
        const TOPIC_INSIGHT_LIMIT = 6;
        const TREND_THRESHOLD = 2;
        let resultsData = [];

        function formatNumber(value, fallback = '-') {
            if (value === null || value === undefined || value === '') return fallback;
            const num = Number(value);
            return Number.isFinite(num) ? numberFormatter.format(num) : fallback;
        }

        function formatDateTime(value) {
            const date = value instanceof Date ? value : new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleString(LOCALE, { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        function formatPercent(value, fallback = '-') {
            if (!Number.isFinite(value)) return fallback;
            return `${formatNumber(value, fallback)}%`;
        }

        function formatSigned(value, fallback = '-') {
            if (!Number.isFinite(value)) return fallback;
            const sign = value > 0 ? '+' : value < 0 ? '' : '';
            return `${sign}${formatNumber(value, fallback)}`;
        }

        function parseHexColor(hex) {
            const match = (hex || '').trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (!match) return null;
            const raw = match[1];
            const full = raw.length === 3 ? raw.split('').map(ch => ch + ch).join('') : raw;
            return {
                r: parseInt(full.slice(0, 2), 16),
                g: parseInt(full.slice(2, 4), 16),
                b: parseInt(full.slice(4, 6), 16),
            };
        }

        function isDarkColor(hex) {
            const rgb = parseHexColor(hex);
            if (!rgb) return false;
            const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
            return luminance < 0.5;
        }

        function normalizeOverlayColor(value) {
            const minAlpha = 0.35;
            const fallback = `rgba(15, 18, 22, ${minAlpha})`;
            if (!value || typeof value !== 'string') return fallback;
            const trimmed = value.trim();
            const rgbaMatch = trimmed.match(/^rgba?\\(([^)]+)\\)$/i);
            if (rgbaMatch) {
                const parts = rgbaMatch[1].split(',').map(part => part.trim());
                const r = Number(parts[0]);
                const g = Number(parts[1]);
                const b = Number(parts[2]);
                if ([r, g, b].some(Number.isNaN)) return fallback;
                const alpha = parts.length > 3 ? Number(parts[3]) : minAlpha;
                const safeAlpha = Math.min(0.9, Math.max(minAlpha, Number.isNaN(alpha) ? minAlpha : alpha));
                return `rgba(${r}, ${g}, ${b}, ${safeAlpha})`;
            }
            const hexMatch = trimmed.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
            if (hexMatch) {
                const rgb = parseHexColor(trimmed);
                if (!rgb) return fallback;
                return `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${minAlpha})`;
            }
            return fallback;
        }

        function applySettings(settings) {
            if (!settings) return;
            const contentBg = settings.contentBg || '#f5f7fb';
            const isDark = isDarkColor(contentBg);
            const rawOpacity = Number(settings.moduleCardOpacity);
            const panelAlpha = Number.isFinite(rawOpacity) ? Math.min(1, Math.max(0.5, rawOpacity)) : 0.92;
            const panelRgb = isDark ? '20, 24, 30' : '255, 255, 255';
            const panelBg = `rgba(${panelRgb}, ${panelAlpha})`;
            const accent = settings.buttonBg || '#4A55A2';
            document.documentElement.style.setProperty('--brand-primary', accent);
            document.documentElement.style.setProperty('--brand-secondary', accent);
            document.documentElement.style.setProperty('--text-dark', isDark ? '#f3f4f6' : '#2C3333');
            document.documentElement.style.setProperty('--text-light', isDark ? '#cbd5f5' : '#576574');
            document.documentElement.style.setProperty('--border-color', isDark ? 'rgba(255, 255, 255, 0.12)' : '#EAEFF2');
            document.documentElement.style.setProperty('--bg-card', panelBg);
            document.documentElement.style.setProperty('--panel-bg', panelBg);
            document.documentElement.style.setProperty('--overlay', normalizeOverlayColor(settings.contentOverlay));
            document.body.style.backgroundColor = 'transparent';
            document.body.style.backgroundImage = 'none';
        }

        function normalizeDifficultyKey(value) {
            if (!value) return '';
            const normalized = value.toString().toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-z]/g, '');
            if (normalized.startsWith('konny') || normalized.startsWith('easy')) return 'konnyu';
            if (normalized.startsWith('kozep') || normalized.startsWith('normal') || normalized.startsWith('medium')) return 'normal';
            if (normalized.startsWith('nehez') || normalized.startsWith('hard')) return 'nehez';
            return normalized;
        }

        function formatDifficultyLabel(value) {
            const raw = (value === null || value === undefined) ? '' : String(value).trim();
            if (!raw) return '-';
            const normalized = normalizeDifficultyKey(raw);
            if (normalized === 'konnyu') return 'Könnyű';
            if (normalized === 'normal') return 'Normál';
            if (normalized === 'nehez') return 'Nehéz';
            return raw;
        }

        function toTimestamp(value) {
            const time = new Date(value).getTime();
            return Number.isFinite(time) ? time : null;
        }

        function getResultScore(result) {
            const percent = Number(result && result.percentage);
            if (Number.isFinite(percent)) return percent;
            const grade = Number(result && result.grade);
            if (Number.isFinite(grade)) return grade * 20;
            return null;
        }

        function getResultGrade(result) {
            const grade = Number(result && result.grade);
            return Number.isFinite(grade) ? grade : null;
        }

        function getSortedResults(results) {
            if (!Array.isArray(results)) return [];
            const mapped = results
                .map((result) => ({ result, ts: toTimestamp(result && result.timestamp) }))
                .filter((entry) => entry.ts !== null);
            mapped.sort((a, b) => b.ts - a.ts);
            return mapped.map((entry) => entry.result);
        }

        function average(values) {
            if (!values.length) return null;
            const total = values.reduce((sum, value) => sum + value, 0);
            return total / values.length;
        }

        const FALLBACK_TOPIC_LABEL = 'Ismeretlen témakör';

        function getTopicLabel(topicId) {
            if (!topicId) return '';
            try {
                const link = window.parent && window.parent.document
                    ? window.parent.document.querySelector(`[data-topic-id="${topicId}"]`)
                    : null;
                if (link) {
                    const textNode = Array.from(link.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.nodeValue.trim());
                    const label = textNode ? textNode.nodeValue.trim() : link.textContent.trim();
                    return label.replace(/\u00ad/g, '').trim();
                }
            } catch (error) {
                // ignore cross-context access issues
            }
            return FALLBACK_TOPIC_LABEL;
        }

        function resolveTopicName(result) {
            if (result && result.topicNameHu) return result.topicNameHu;
            if (result && result.topicName) return result.topicName;
            return getTopicLabel(result && result.topicId);
        }

        function buildTrendSummary(sortedResults) {
            const scored = sortedResults
                .map((result) => ({ score: getResultScore(result) }))
                .filter((entry) => Number.isFinite(entry.score));
            const last = scored.slice(0, TREND_WINDOW).map((entry) => entry.score);
            const prev = scored.slice(TREND_WINDOW, TREND_WINDOW * 2).map((entry) => entry.score);
            const lastAvg = average(last);
            const prevAvg = average(prev);
            const delta = Number.isFinite(lastAvg) && Number.isFinite(prevAvg) ? lastAvg - prevAvg : null;
            const direction = delta === null
                ? 'none'
                : delta > TREND_THRESHOLD ? 'up' : delta < -TREND_THRESHOLD ? 'down' : 'flat';
            return {
                total: scored.length,
                lastCount: last.length,
                prevCount: prev.length,
                lastAvg,
                prevAvg,
                delta,
                direction,
            };
        }

        function getDirectionLabel(direction) {
            if (direction === 'up') return { label: 'Emelked\u0151', className: 'trend-chip up' };
            if (direction === 'down') return { label: 'Cs\u00f6kken\u0151', className: 'trend-chip down' };
            if (direction === 'flat') return { label: 'Stabil', className: 'trend-chip flat' };
            return { label: 'Nincs adat', className: 'trend-chip flat' };
        }

        function buildTopicInsights(sortedResults) {
            const grouped = new Map();
            sortedResults.forEach((result) => {
                const topicId = result && result.topicId ? result.topicId : null;
                const key = topicId || (result && result.topicName ? result.topicName : 'ismeretlen');
                if (!grouped.has(key)) {
                    grouped.set(key, {
                        key,
                        topicId,
                        title: resolveTopicName(result),
                        entries: [],
                    });
                }
                const score = getResultScore(result);
                const grade = getResultGrade(result);
                const ts = toTimestamp(result && result.timestamp);
                grouped.get(key).entries.push({ score, grade, ts });
            });

            const insights = [];
            grouped.forEach((group) => {
                const validEntries = group.entries.filter((entry) => Number.isFinite(entry.score) && entry.ts !== null);
                validEntries.sort((a, b) => b.ts - a.ts);
                if (!validEntries.length) return;
                const scores = validEntries.map((entry) => entry.score);
                const avgScore = average(scores);
                const avgGrade = average(validEntries.map((entry) => entry.grade).filter((value) => Number.isFinite(value)));
                const last = validEntries[0];
                const prev = validEntries[1];
                const delta = last && prev ? last.score - prev.score : null;
                let direction = 'flat';
                if (delta === null) {
                    direction = 'none';
                } else if (delta > TREND_THRESHOLD) {
                    direction = 'up';
                } else if (delta < -TREND_THRESHOLD) {
                    direction = 'down';
                }
                insights.push({
                    topicId: group.topicId,
                    title: group.title || group.key,
                    attempts: validEntries.length,
                    avgScore,
                    avgGrade,
                    lastScore: last.score,
                    delta,
                    direction,
                    lastTs: last.ts,
                });
            });
            insights.sort((a, b) => b.lastTs - a.lastTs);
            return insights.slice(0, TOPIC_INSIGHT_LIMIT);
        }

        function renderTrendSummary(sortedResults) {
            const summary = buildTrendSummary(sortedResults);
            if (!summary.total) {
                trendEmpty.style.display = 'block';
                trendNote.textContent = '';
                trendWindowLabel.textContent = 'M\u00e9g nincs trendadat';
                trendLastAvg.textContent = '-';
                trendPrevAvg.textContent = '-';
                trendDelta.textContent = '-';
                trendLastCount.textContent = '0 teszt';
                trendPrevCount.textContent = '0 teszt';
                const label = getDirectionLabel('none');
                trendDirection.textContent = label.label;
                trendDirection.className = label.className;
                return;
            }
            trendEmpty.style.display = 'none';
            const totalWindow = Math.min(summary.total, TREND_WINDOW * 2);
            trendWindowLabel.textContent = `Ut\u00f3bbi ${totalWindow} teszt alapj\u00e1n`;
            trendLastAvg.textContent = formatPercent(summary.lastAvg, '-');
            trendPrevAvg.textContent = summary.prevCount ? formatPercent(summary.prevAvg, '-') : '-';
            trendLastCount.textContent = `${summary.lastCount} teszt`;
            trendPrevCount.textContent = `${summary.prevCount} teszt`;
            if (summary.prevCount) {
                trendDelta.textContent = `${formatSigned(summary.delta, '-')}\u0025`;
            } else {
                trendDelta.textContent = '-';
            }
            const label = getDirectionLabel(summary.direction);
            trendDirection.textContent = label.label;
            trendDirection.className = label.className;
            if (summary.prevCount) {
                trendNote.textContent = 'A trend az ut\u00f3bbi \u00e9s az azt megel\u0151z\u0151 5 teszt \u00e1tlag\u00e1t hasonl\u00edtja \u00f6ssze.';
            } else {
                trendNote.textContent = 'T\u00f6lts ki legal\u00e1bb 6 tesztet a r\u00e9szletes trendhez.';
            }
        }

        function renderTopicInsights(sortedResults) {
            const insights = buildTopicInsights(sortedResults);
            topicInsightsList.innerHTML = '';
            if (!insights.length) {
                topicInsightsEmpty.style.display = 'block';
                return;
            }
            topicInsightsEmpty.style.display = 'none';
            insights.forEach((insight) => {
                const item = document.createElement('div');
                item.className = 'topic-item';
                const avgText = Number.isFinite(insight.avgScore) ? formatPercent(insight.avgScore, '-') : '-';
                const lastText = Number.isFinite(insight.lastScore) ? formatPercent(insight.lastScore, '-') : '-';
                const attemptsText = `${formatNumber(insight.attempts, '0')} pr\u00f3ba`;
                const gradeText = Number.isFinite(insight.avgGrade)
                    ? `\u00c1tlagjegy: ${formatNumber(insight.avgGrade, '-')}`
                    : 'Nincs \u00e1tlagjegy';
                const deltaText = insight.delta === null ? '-' : `${formatSigned(insight.delta, '-')}\u0025`;
                const directionLabel = getDirectionLabel(insight.direction);
                item.innerHTML = `<div class="topic-info"><strong>${insight.title || 'Ismeretlen'}</strong><div class="topic-meta">${gradeText} \u00b7 \u00c1tlag: ${avgText} \u00b7 Ut\u00f3bbi: ${lastText} \u00b7 ${attemptsText}</div></div><span class="${directionLabel.className}">${directionLabel.label} ${deltaText}</span>`;
                topicInsightsList.appendChild(item);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            container.innerHTML = `<div class="no-results"><p>Eredményeim betöltése...</p></div>`;
            window.parent.postMessage({ type: 'get-all-results' }, '*');
            window.parent.postMessage({ type: 'request-xp-summary' }, '*');
            window.parent.postMessage({ type: 'request-settings' }, '*');
            window.addEventListener('message', (event) => {
                if (event.data.type === 'all-results-response') {
                    resultsData = Array.isArray(event.data.results) ? event.data.results : [];
                    renderResults();
                }
                if (event.data.type === 'xp-summary') {
                    updateXpSummary(event.data.summary);
                }
                if (event.data.type === 'apply-settings') {
                    applySettings(event.data.settings);
                }
            });
        });

        function renderResults() {
            const sortedResults = getSortedResults(resultsData);
            container.innerHTML = '';
            if (!sortedResults.length) {
                container.innerHTML = `<div class="no-results"><h3>Még nincsenek mentett teszteredmények.</h3><p>Tölts ki egy tesztet, és az eredmény itt fog megjelenni!</p></div>`;
                renderTrendSummary([]);
                renderTopicInsights([]);
                return;
            }

            sortedResults.forEach(result => {
                if (!result || !result.timestamp) return;
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                const dateText = formatDateTime(result.timestamp) || '-';
                const gradeValue = result.grade !== null && result.grade !== undefined && result.grade !== ''
                    ? Number(result.grade)
                    : Number.NaN;
                const gradeText = Number.isFinite(gradeValue) ? formatNumber(gradeValue) : '-';
                const gradeClass = Number.isFinite(gradeValue) ? `grade-${gradeValue}` : '';
                const percentageValue = result.percentage !== null && result.percentage !== undefined && result.percentage !== ''
                    ? Number(result.percentage)
                    : Number.NaN;
                const percentageText = Number.isFinite(percentageValue) ? formatNumber(percentageValue) : '-';
                const topicTitle = result.topicName || getTopicLabel(result.topicId);
                const difficultyLabel = formatDifficultyLabel(result.difficulty || result.difficultyLabel || result.difficultyName);
                resultItem.innerHTML = `<div class="grade-badge ${gradeClass}">${gradeText}</div> <div class="result-details"> <h3>${topicTitle || 'Ismeretlen'}</h3> <p><b>Nehézségi szint:</b> ${difficultyLabel} | <b>Eredmény:</b> ${percentageText}% | <b>Dátum:</b> ${dateText}</p> </div> <div class="result-actions"><button>Részletek</button></div>`;
                const detailsBtn = resultItem.querySelector('button');
                detailsBtn.addEventListener('click', () => showDetails(result));
                container.appendChild(resultItem);
            });

            renderTrendSummary(sortedResults);
            renderTopicInsights(sortedResults);
        }

        function updateXpSummary(summary) {
            if (!summary || !summary.level) return;
            const totalXp = summary.xp || 0;
            resultsLevel.textContent = formatNumber(summary.level.level, '1');
            resultsTotalXp.textContent = `${formatNumber(totalXp, '0')} XP`;
            const current = Number.isFinite(summary.level.xpIntoLevel) ? summary.level.xpIntoLevel : 0;
            const required = Number.isFinite(summary.level.xpForNext) ? summary.level.xpForNext : 0;
            const isMaxLevel = required <= 0;
            const safeRequired = isMaxLevel ? Math.max(1, current) : required;
            const percent = Math.min(100, Math.round((current / safeRequired) * 100));
            const xpToNext = Math.max(0, required - current);
            resultsXpProgress.style.width = `${percent}%`;
            resultsXpText.textContent = isMaxLevel
                ? `Következő szint: Max`
                : `Következő szint: ${formatNumber(xpToNext, '0')} XP`;
        }
        function showDetails(result) {
            const topicTitle = result.topicName || getTopicLabel(result.topicId);
            let detailsHTML = `<h2>${topicTitle || 'Ismeretlen'} - Kiértékelés</h2>`;
            result.questions.forEach((q, index) => {
                const isCorrect = q.userAnswer === q.correctAnswer;
                const userAnswerText = q.options ? q.options[q.userAnswer] : q.userAnswer;
                const correctAnswerText = q.options ? q.options[q.correctAnswer] : q.correctAnswer;
                detailsHTML += `<div class="question-review"> <p><b>${index + 1}. kérdés:</b> ${q.question}</p> <div class="user-answer ${isCorrect ? 'correct' : 'incorrect'}"> Te válaszod: ${userAnswerText || '<i>(nem válaszolt)</i>'} </div> ${!isCorrect ? `<div class="correct-answer">Helyes válasz: ${correctAnswerText}</div>` : ''} </div>`;
            });
            modalBody.innerHTML = detailsHTML;
            modal.classList.add('active');
            modalCloseBtn.focus();
            renderAllMath();
        }

        function closeDetails() { modal.classList.remove('active'); modalBody.innerHTML = ''; }
        modalCloseBtn.addEventListener('click', closeDetails);
        modal.addEventListener('click', (event) => { if (event.target === modal) { closeDetails(); } });
    </script>
</body>
</html>
